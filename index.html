<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Instrumentación - Cloud & Multi-Usuario</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Libraries -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0",
                "lucide-react": "https://esm.sh/lucide-react@0.330.0?deps=react@18.2.0,react-dom@18.2.0",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #64748b; font-weight: 500; }
        
        .input-edit { border: 1px solid #e2e8f0; border-radius: 4px; padding: 2px 6px; width: 100%; font-size: 0.75rem; color: #334155; }
        .input-edit:focus { border-color: #3b82f6; outline: none; background-color: #fff; }
        .input-edit:disabled { background-color: #f1f5f9; cursor: not-allowed; }
        
        .select-edit { border: 1px solid #e2e8f0; border-radius: 4px; padding: 2px; font-size: 0.75rem; background-color: white; width: 100%; cursor: pointer; }
        .select-edit:disabled { background-color: #f1f5f9; cursor: not-allowed; }
        
        .animate-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, PieChart, Pie, Cell, ResponsiveContainer, Label, LabelList } from 'recharts';
        import { AlertCircle, CheckCircle, Clock, Activity, Upload, Trash2, HardHat, Download, X, AlertTriangle, Target, Layers, FileSpreadsheet, LayoutDashboard, ChevronDown, ChevronRight, Boxes, PlayCircle, Wrench, Zap, Hammer, FileWarning, Package, Truck, ClipboardCheck, Edit3, Save, Eye, EyeOff, FileCheck, RefreshCw, Lock, Settings, Shield, LogOut } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, onSnapshot } from "firebase/firestore";

        // GLOBAL APP ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'instrument-dashboard-v1';

        // --- CONSTANTES & DATA ---
        const initialSystemData = [
            { especialidad: "Instrumentacion (I)", tag: "TI-801B", descripcion: "Termometro", sistema: "011", descSistema: "Recepcion", subsistema: "001", descSubsistema: "Ingreso", skid: "ON", almacen: "EN OBRA", aCalibrar: "1", provision: "YPF", cantRegTot: "2", cantRegReal: "2", estado1: "", estado2: "INST" },
            { especialidad: "Mecánica", tag: "V-101", descripcion: "Separador", sistema: "010", descSistema: "Separación", subsistema: "002", descSubsistema: "V-101", skid: "SK-V101", almacen: "", aCalibrar: "0", provision: "", cantRegTot: "5", cantRegReal: "3", estado1: "", estado2: "" }
        ];
        const initialRegData = [
             { skid: "ON", ubicacion: "PENDIENTE", tag: "AIT-107", lab: "CIS", fCalib: "2026-01-19", estadoReg: "PRESENTADO", fGen: "2026-01-20", fPres: "2026-01-23", fDev: "", ubicReg: "INSPECCIÓN", montado: "SIN MONTAR" },
             { skid: "ON", ubicacion: "EN OBRA", tag: "BDV-102C", lab: "", fCalib: "2025-11-29", estadoReg: "FIRMADO", fGen: "2025-11-29", fPres: "2025-11-29", fDev: "2025-11-29", ubicReg: "PRECOM", montado: "MONTADO" }
        ];
        const COLORS = { blue: "#3b82f6", green: "#10b981", orange: "#f97316", red: "#ef4444", yellow: "#eab308", purple: "#a855f7", indigo: "#6366f1", gray: "#64748b" };

        // --- HELPERS ---
        const normalizeDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return "";
            const cleanStr = dateStr.trim();
            const match = cleanStr.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = match[2].padStart(2, '0');
                const year = match[3];
                return `${year}-${month}-${day}`;
            }
            if (cleanStr.match(/^\d{4}-\d{2}-\d{2}$/)) return cleanStr;
            return ""; 
        };

        // --- COMPONENTS ---
        const MetricCard = ({ title, value, icon: Icon, color, subtext, percentage }) => (
            <div className="bg-white p-4 rounded-lg shadow-sm border-l-4 relative overflow-hidden" style={{ borderLeftColor: color }}>
                <div className="flex justify-between items-center z-10 relative">
                    <div><p className="text-slate-400 text-xs font-bold uppercase">{title}</p><h3 className="text-3xl font-bold text-slate-700 flex items-baseline gap-2">{value}{percentage && <span className="text-sm font-normal text-slate-400">({percentage}%)</span>}</h3></div>
                    <div className={`p-3 rounded-full bg-opacity-10`} style={{ backgroundColor: `${color}20` }}><Icon size={24} color={color} /></div>
                </div>
                {subtext && <p className="text-xs text-slate-400 mt-2">{subtext}</p>}
            </div>
        );

        const ProgressBar = ({ current, total, color = "bg-blue-600" }) => {
            const percent = total > 0 ? Math.min(100, (current / total) * 100) : 0;
            return (<div className="w-full bg-slate-200 rounded-full h-2 mt-1"><div className={`h-2 rounded-full transition-all duration-500 ${color}`} style={{ width: `${percent}%` }}></div></div>);
        };

        // --- AUTH & CONFIG COMPONENTS ---
        const FirebaseConfigModal = ({ onSave }) => {
            const [configStr, setConfigStr] = useState('');
            const [error, setError] = useState('');
            useEffect(() => {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    try { onSave(JSON.parse(__firebase_config)); } catch(e) {}
                }
            }, []);
            const handleSave = () => {
                try {
                    const config = JSON.parse(configStr);
                    if (!config.apiKey) throw new Error("Falta apiKey");
                    localStorage.setItem('firebaseConfig', JSON.stringify(config));
                    onSave(config);
                } catch (e) { setError("JSON inválido."); }
            };
            return (
                <div className="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100] p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-8 animate-enter">
                        <div className="flex items-center gap-3 mb-4 text-orange-600"><Settings size={32} /><h2 className="text-2xl font-bold text-slate-800">Configuración Inicial</h2></div>
                        <p className="text-slate-600 mb-4 text-sm">Pega aquí tu configuración de Firebase (JSON).</p>
                        <textarea className="w-full h-40 p-3 border border-slate-300 rounded-lg font-mono text-xs mb-2 outline-none" value={configStr} onChange={(e) => setConfigStr(e.target.value)} placeholder='{ "apiKey": "..." }'/>
                        {error && <p className="text-red-500 text-xs mb-4">{error}</p>}
                        <button onClick={handleSave} className="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-bold">Conectar</button>
                        <div className="mt-4 text-center"><a href="#" onClick={(e) => {e.preventDefault(); localStorage.setItem('demoMode', 'true'); window.location.reload()}} className="text-xs text-slate-400 underline">Modo Demo</a></div>
                    </div>
                </div>
            );
        };

        const Login = ({ auth }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                try { await signInWithEmailAndPassword(auth, email, password); } catch (err) { setError("Error de autenticación."); } finally { setLoading(false); }
            };
            return (
                <div className="fixed inset-0 bg-slate-50 flex items-center justify-center z-[90]">
                    <div className="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm border border-slate-100 animate-enter">
                        <div className="flex justify-center mb-6"><div className="p-4 bg-blue-100 rounded-full text-blue-600"><Lock size={32}/></div></div>
                        <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">Acceso Seguro</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-xs font-medium text-slate-700 mb-1">Usuario</label><input type="email" required className="w-full p-2 border border-slate-300 rounded-lg" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                            <div><label className="block text-xs font-medium text-slate-700 mb-1">Contraseña</label><input type="password" required className="w-full p-2 border border-slate-300 rounded-lg" value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                            {error && <p className="text-red-500 text-xs">{error}</p>}
                            <button type="submit" disabled={loading} className="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex justify-center gap-2">{loading ? <RefreshCw className="animate-spin" size={18}/> : "Ingresar"}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const UserManagement = ({ isOpen, onClose, db, currentUserEmail }) => {
            const [users, setUsers] = useState([]);
            const [newUserEmail, setNewUserEmail] = useState('');
            const [newUserRole, setNewUserRole] = useState('viewer');
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');
            
            // Fix: Construct collection reference correctly with proper path segments
            // Path: artifacts/{appId}/public/data/user_roles/{email} -> 'user_roles' is the collection
            const rolesCollection = useMemo(() => db ? collection(db, 'artifacts', appId, 'public', 'data', 'user_roles') : null, [db]);

            useEffect(() => {
                if(isOpen && rolesCollection) {
                    const fetchUsers = async () => {
                        try {
                            const snap = await getDocs(rolesCollection);
                            setUsers(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        } catch (e) { console.error(e); }
                    };
                    fetchUsers();
                }
            }, [isOpen, rolesCollection]);

            const handleCreateUser = async () => {
                if(!newUserEmail || !rolesCollection) return;
                setLoading(true);
                try {
                    await setDoc(doc(rolesCollection, newUserEmail), { email: newUserEmail, role: newUserRole, createdBy: currentUserEmail, createdAt: new Date().toISOString() });
                    setMsg("Rol asignado.");
                    const snap = await getDocs(rolesCollection);
                    setUsers(snap.docs.map(d => ({id: d.id, ...d.data()})));
                    setNewUserEmail('');
                } catch (e) { setMsg("Error: " + e.message); }
                setLoading(false);
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80] p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 animate-enter">
                        <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold text-purple-600 flex gap-2"><Shield/> Gestión de Usuarios</h3><button onClick={onClose}><X/></button></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="border-r pr-6 space-y-3">
                                <h4 className="font-medium text-sm">Asignar Rol</h4>
                                <input type="email" placeholder="Correo" className="input-edit" value={newUserEmail} onChange={e=>setNewUserEmail(e.target.value)}/>
                                <select className="select-edit" value={newUserRole} onChange={e=>setNewUserRole(e.target.value)}><option value="viewer">Visualizador</option><option value="admin">Administrador</option></select>
                                <button onClick={handleCreateUser} disabled={loading} className="w-full py-2 bg-purple-600 text-white rounded text-sm">Guardar</button>
                                {msg && <p className="text-xs text-green-600">{msg}</p>}
                            </div>
                            <div className="max-h-60 overflow-y-auto space-y-2">
                                <h4 className="font-medium text-sm">Usuarios</h4>
                                {users.map(u => (<div key={u.id} className="p-2 border rounded flex justify-between"><div><p className="text-xs font-bold">{u.id}</p><p className="text-[10px] uppercase">{u.role}</p></div><div className={`w-2 h-2 rounded-full ${u.role==='admin'?'bg-red-500':'bg-green-500'}`}></div></div>))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD COMPONENTS ---
        const RegEditRow = ({ row, onEdit, readOnly }) => (
            <tr className="bg-white hover:bg-slate-50 border-b border-slate-100">
                <td className="px-6 py-1 font-medium text-xs">{row.tag}</td>
                <td className="px-2 py-1"><select disabled={readOnly} className="select-edit" value={row.proveedor} onChange={e=>onEdit(row.tag,'lab',e.target.value)}><option value="">-</option><option value="Pecom">Pecom</option><option value="CIS">CIS</option><option value="WEISZ">WEISZ</option></select></td>
                <td className="px-2 py-1"><input disabled={readOnly} type="date" className="input-edit" value={row.fechaGen} onChange={e=>onEdit(row.tag,'fGen',e.target.value)}/></td>
                <td className="px-2 py-1"><input disabled={readOnly} type="date" className="input-edit" value={row.fechaPres} onChange={e=>onEdit(row.tag,'fPres',e.target.value)}/></td>
                <td className="px-2 py-1"><input disabled={readOnly} type="date" className="input-edit" value={row.fechaDev} onChange={e=>onEdit(row.tag,'fDev',e.target.value)}/></td>
                <td className="px-6 py-1"><span className={`text-[10px] font-bold px-2 py-0.5 rounded ${row.estadoDoc==='FINALIZADO'?'bg-green-100 text-green-700': row.estadoDoc==='EN INSPECCIÓN'?'bg-blue-100 text-blue-700':'bg-yellow-100 text-yellow-700'}`}>{row.estadoDoc}</span></td>
                <td className="px-6 py-1 font-bold text-right text-xs text-slate-600">{row.ubicacion}</td>
                <td className="px-2 py-1"><select disabled={readOnly} className="select-edit" value={row.montado} onChange={e=>onEdit(row.tag,'montado',e.target.value)}><option value="SIN MONTAR">SIN MONTAR</option><option value="MONTADO">MONTADO</option></select></td>
            </tr>
        );

        const TagEditRow = ({ tagItem, onEdit, skidOptions, almacenOptions, readOnly }) => {
            const rowColor = tagItem.calculatedStatus === "INSTALADO" ? "bg-green-50/60" : (tagItem.calculatedStatus === "EN PROCESO" ? "bg-yellow-50/60" : "hover:bg-slate-50");
            return (
                <tr className={`border-b border-slate-100 transition-colors ${rowColor}`}>
                    <td className="px-4 py-1 font-medium text-xs">{tagItem.tag}</td>
                    <td className="px-2 py-1"><select disabled={readOnly} className="select-edit" value={tagItem.skid} onChange={e=>onEdit(tagItem.tag,'skid',e.target.value)}><option value="">-</option>{skidOptions.map(o=><option key={o} value={o}>{o}</option>)}</select></td>
                    <td className="px-2 py-1"><select disabled={readOnly} className="select-edit" value={tagItem.almacen} onChange={e=>onEdit(tagItem.tag,'almacen',e.target.value)}><option value="">-</option>{almacenOptions.map(o=><option key={o} value={o}>{o}</option>)}</select></td>
                    <td className="px-2 py-1 w-16"><input disabled={readOnly} type="number" className="input-edit text-center" value={tagItem.cantRegReal} onChange={e=>onEdit(tagItem.tag,'cantRegReal',e.target.value)}/></td>
                    <td className="px-2 py-1 text-center"><span className="text-[10px] font-bold">{tagItem.calculatedStatus}</span></td>
                </tr>
            );
        };

        // --- MAIN APP ---
        function InstrumentDashboard() {
            // Firebase State
            const [fbConfig, setFbConfig] = useState(null);
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState('viewer');
            const [appState, setAppState] = useState('init');

            // Data State
            const [matrixData, setMatrixData] = useState([]);
            const [regData, setRegData] = useState([]);
            const [manualEdits, setManualEdits] = useState({});
            
            // UI State
            const [activeTab, setActiveTab] = useState("dashboard");
            const [filter, setFilter] = useState("TODOS");
            const [isSyncing, setIsSyncing] = useState(false);
            const [expandedRows, setExpandedRows] = useState({});
            const [isUserModalOpen, setIsUserModalOpen] = useState(false);
            const [hideDeleted, setHideDeleted] = useState(true);
            const [skidOptions, setSkidOptions] = useState([]);
            const [almacenOptions, setAlmacenOptions] = useState([]);

            const fileRef = useRef(null);
            const regRef = useRef(null);

            // 1. Initialization
            useEffect(() => {
                const cfg = localStorage.getItem('firebaseConfig');
                const demo = localStorage.getItem('demoMode');
                if(cfg) { try { setFbConfig(JSON.parse(cfg)); } catch(e){} }
                else if(!demo) { /* Wait for config modal */ }
                else { setAppState('app'); setUserRole('admin'); setMatrixData(initialSystemData); setRegData(initialRegData); }
            }, []);

            const { auth, db } = useMemo(() => {
                if(!fbConfig) return {auth:null, db:null};
                try { const app = initializeApp(fbConfig); return { auth: getAuth(app), db: getFirestore(app) }; } catch(e) { return {auth:null, db:null}; }
            }, [fbConfig]);

            // 2. Auth & Role Check
            useEffect(() => {
                if(auth) {
                    setAppState('login');
                    return onAuthStateChanged(auth, async (u) => {
                        if(u) {
                            setUser(u);
                            try {
                                const roleRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_roles', u.email);
                                const roleDoc = await getDoc(roleRef);
                                if (roleDoc.exists()) {
                                    setUserRole(roleDoc.data().role);
                                } else {
                                    // AUTO-ASSIGN ROLES FOR SPECIFIED USERS (AS REQUESTED)
                                    let assignedRole = 'viewer';
                                    if (u.email === "jeronimo.aranda@gmail.com") assignedRole = 'admin';
                                    if (u.email === "jeronimo.aranda@pecomenergia.com.ar") assignedRole = 'viewer';
                                    
                                    await setDoc(roleRef, { email: u.email, role: assignedRole, createdAt: new Date().toISOString() });
                                    setUserRole(assignedRole);
                                }
                            } catch(e) { setUserRole('viewer'); }
                            setAppState('app');
                        } else { setAppState('login'); }
                    });
                }
            }, [auth, db]);

            // 3. Data Sync
            useEffect(() => {
                if(db && appState === 'app') {
                    // Path: artifacts/{appId}/public/data/project_state/main
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'project_state', 'main');
                    return onSnapshot(docRef, (snap) => {
                        if(snap.exists()) {
                            const d = snap.data();
                            if(d.matrixData) setMatrixData(JSON.parse(d.matrixData));
                            if(d.regData) setRegData(JSON.parse(d.regData));
                            if(d.manualEdits) setManualEdits(JSON.parse(d.manualEdits));
                        }
                    });
                }
            }, [db, appState]);

            // Actions
            const saveToCloud = async () => {
                if(!db || userRole !== 'admin') return;
                setIsSyncing(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'project_state', 'main'), {
                        matrixData: JSON.stringify(matrixData),
                        regData: JSON.stringify(regData),
                        manualEdits: JSON.stringify(manualEdits),
                        lastUpdate: new Date().toISOString(),
                        updatedBy: user.email
                    });
                    alert("Datos guardados en la nube.");
                } catch(e) { alert("Error: " + e.message); }
                setIsSyncing(false);
            };

            const handleTagEdit = (tag, field, value) => {
                if(userRole !== 'admin') return;
                setManualEdits(prev => {
                    const next = { ...prev, [tag]: { ...prev[tag], [field]: value } };
                    // Auto-update location if regs complete
                    if (field === 'cantRegReal') {
                        const item = matrixData.find(d => d.tag === tag);
                        const tot = parseInt(next[tag].cantRegTot ?? item.cantRegTot);
                        if (parseInt(value) >= tot && tot > 0) next[tag].almacen = 'EN OBRA';
                    }
                    return next;
                });
            };

            const handleRegEdit = (tag, field, value) => {
                if(userRole !== 'admin') return;
                setRegData(prev => prev.map(item => {
                    if(item.tag === tag) {
                        let newState = item.estadoDoc;
                        // Auto-calculate logic
                        if (field === 'fDev' && value) newState = "FINALIZADO";
                        else if (field === 'fPres' && value) newState = "EN INSPECCIÓN";
                        else if (field === 'fGen' && value) newState = "EN LABORATORIO";
                        return { ...item, [field]: value, estadoDoc: newState };
                    }
                    return item;
                }));
            };

            // Option Lists Calculation
            useEffect(() => {
                const uniqueSkids = new Set(); const uniqueAlmacenes = new Set();
                matrixData.forEach(item => { if(item.skid) uniqueSkids.add(item.skid); if(item.almacen) uniqueAlmacenes.add(item.almacen); });
                uniqueAlmacenes.add("EN OBRA");
                setSkidOptions(Array.from(uniqueSkids).sort()); setAlmacenOptions(Array.from(uniqueAlmacenes).sort());
            }, [matrixData]);

            // File Handlers (Simplified)
            const handleFile = (e, type) => {
                const file = e.target.files[0]; if(!file) return; const reader = new FileReader();
                reader.onload = (ev) => {
                    const rows = ev.target.result.split('\n'); const del = rows[0].includes(';') ? ';' : ','; const headers = rows[0].toUpperCase().split(del).map(h=>h.trim());
                    const idx = (key) => headers.findIndex(h => h.includes(key));
                    const data = [];
                    rows.forEach((r,i) => {
                        if(i===0) return; const c = r.split(del);
                        if (type === 'matrix' && c[idx('TAG')]) {
                            data.push({
                                tag: c[idx('TAG')], especialidad: c[idx('ESP')]||"", sistema: c[idx('SIS')]||"", descSistema: c[idx('DESC')]||"", subsistema: c[idx('SUB')]||"", descSubsistema: c[idx('SUBS')]||"",
                                skid: c[idx('SKID')]||"", almacen: c[idx('ALM')]||"", aCalibrar: c[idx('CALIB')]||"", cantRegTot: c[idx('TOT')]||"0", cantRegReal: c[idx('REAL')]||"0", estado2: c[idx('EST2')]||""
                            });
                        } else if (type === 'reg' && c[idx('TAG')]) {
                            data.push({
                                tag: c[idx('TAG')], skid: c[idx('SKID')]||"", ubicacion: c[idx('UBIC')]||"", lab: c[idx('LAB')]||"", fCalib: normalizeDate(c[idx('CALIB')]),
                                estadoReg: c[idx('EST')]||"", fGen: normalizeDate(c[idx('GEN')]), fPres: normalizeDate(c[idx('PRES')]), fDev: normalizeDate(c[idx('DEV')]), montado: c[idx('MONT')]||""
                            });
                        }
                    });
                    if(type === 'matrix') { setMatrixData(data); setManualEdits({}); } else { setRegData(data); }
                };
                reader.readAsText(file);
            };

            // Derived Data for Render
            const calculateState = (item, edit) => {
                const tot = parseInt(edit?.cantRegTot ?? item.cantRegTot) || 0;
                const real = parseInt(edit?.cantRegReal ?? item.cantRegReal) || 0;
                if(tot > 0 && real >= tot) return "INSTALADO";
                if(real > 0) return "EN PROCESO";
                return "PENDIENTE";
            };

            const processedMatrixData = useMemo(() => {
                return matrixData.map(d => {
                    const ed = manualEdits[d.tag] || {};
                    return { ...d, ...ed, calculatedStatus: calculateState(d, ed) };
                });
            }, [matrixData, manualEdits]);

            const systemsStats = useMemo(() => {
                const grouped = {};
                processedMatrixData.forEach(item => {
                    if(item.estado1?.includes("ELIMINADO")) return;
                    const key = `${item.sistema}|${item.subsistema}`;
                    if(!grouped[key]) grouped[key] = { id: key, sistema: item.sistema, descSistema: item.descSistema, subsistema: item.subsistema, descSubsistema: item.descSubsistema, totalTags: 0, mountedTags: 0, tags: [] };
                    grouped[key].totalTags++;
                    if(item.calculatedStatus === 'INSTALADO') grouped[key].mountedTags++;
                    grouped[key].tags.push(item);
                });
                return Object.values(grouped).map(g => ({...g, percent: g.totalTags>0 ? ((g.mountedTags/g.totalTags)*100).toFixed(0) : 0}));
            }, [processedMatrixData]);

            // Calculated startedSubsystems here to avoid reference error
            const startedSubsystems = useMemo(() => systemsStats.filter(s => s.mountedTags > 0).length, [systemsStats]);

            const flatRegData = useMemo(() => {
                return regData.map(item => {
                     let status = "PENDIENTE";
                     if (item.fDev) status = "FINALIZADO"; else if (item.fPres) status = "EN INSPECCIÓN"; else if (item.fGen) status = "EN LABORATORIO";
                     const fisica = (item.montado && item.montado !== "SIN MONTAR") ? "EN OBRA" : (item.ubicacion || "PENDIENTE");
                     return { ...item, ubicacion: fisica, estadoDoc: status };
                });
            }, [regData]);
            
            const filteredRegList = filter === "TODOS" ? flatRegData : flatRegData.filter(d => d.estadoDoc === filter || d.ubicacion === filter);

            // RENDER
            if(!fbConfig && !localStorage.getItem('demoMode')) return <FirebaseConfigModal onSave={setFbConfig} />;
            if(appState === 'login') return <Login auth={auth} onLogin={()=>{}} />;

            return (
                <div className="min-h-screen bg-slate-50 p-6 font-sans">
                    <UserManagement isOpen={isUserModalOpen} onClose={() => setIsUserModalOpen(false)} db={db} currentUserEmail={user?.email} />
                    
                    <div className="flex flex-col gap-4 mb-6">
                        <div className="flex flex-col xl:flex-row justify-between items-center bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <div><h1 className="text-3xl font-bold text-slate-800">Seguimiento de Obra {userRole==='viewer' && <span className="text-xs bg-gray-100 px-2 py-1 rounded">Solo Lectura</span>}</h1></div>
                            <div className="flex gap-2">
                                {userRole === 'admin' && (<>
                                    <button onClick={saveToCloud} disabled={isSyncing} className="bg-indigo-600 text-white px-4 py-2 rounded text-sm">{isSyncing?"...":"Sincronizar"}</button>
                                    <input type="file" ref={fileRef} onChange={(e)=>handleFile(e,'matrix')} className="hidden" /><button onClick={()=>fileRef.current.click()} className="bg-purple-600 text-white px-4 py-2 rounded text-sm">Matriz</button>
                                    <input type="file" ref={regRef} onChange={(e)=>handleFile(e,'reg')} className="hidden" /><button onClick={()=>regRef.current.click()} className="bg-blue-600 text-white px-4 py-2 rounded text-sm">Registro</button>
                                    <button onClick={()=>setIsUserModalOpen(true)} className="p-2 bg-slate-100 rounded-full"><Settings size={20}/></button>
                                </>)}
                                {user && <button onClick={()=>signOut(auth)} className="p-2 text-red-500 rounded-full"><LogOut/></button>}
                            </div>
                        </div>
                        <div className="flex gap-6 border-b border-slate-200 px-4">
                            <button onClick={()=>setActiveTab('dashboard')} className={`pb-2 px-4 font-medium ${activeTab==='dashboard'?'text-blue-600 border-b-2 border-blue-600':'text-slate-500'}`}>Registro</button>
                            <button onClick={()=>setActiveTab('systems')} className={`pb-2 px-4 font-medium ${activeTab==='systems'?'text-blue-600 border-b-2 border-blue-600':'text-slate-500'}`}>Sistemas</button>
                        </div>
                    </div>

                    {activeTab === 'dashboard' && (
                        <div className="animate-enter">
                             <div className="bg-white rounded-lg shadow overflow-hidden border border-slate-200 mt-6">
                                <div className="p-4 border-b flex justify-between items-center"><h3 className="font-bold">Listado de Registros (ABM)</h3><select className="select-edit w-48" value={filter} onChange={e=>setFilter(e.target.value)}><option value="TODOS">Todos</option><option value="FINALIZADO">Finalizados</option></select></div>
                                <div className="overflow-x-auto max-h-[600px]"><table className="w-full text-sm text-left"><thead className="bg-slate-100"><tr><th>TAG</th><th>Lab</th><th>Gen</th><th>Pres</th><th>Dev</th><th>Est</th><th>Ubic</th><th>Montado</th></tr></thead><tbody>
                                    {filteredRegList.map((row, i) => (
                                        <tr key={i} className="border-b">
                                            <td className="px-4 py-1">{row.tag}</td>
                                            <td><select disabled={userRole!=='admin'} className="select-edit" value={row.proveedor} onChange={e=>handleRegEdit(row.tag,'lab',e.target.value)}><option value="">-</option><option value="Pecom">Pecom</option><option value="CIS">CIS</option></select></td>
                                            <td><input disabled={userRole!=='admin'} type="date" className="input-edit" value={row.fechaGen} onChange={e=>handleRegEdit(row.tag,'fGen',e.target.value)}/></td>
                                            <td><input disabled={userRole!=='admin'} type="date" className="input-edit" value={row.fechaPres} onChange={e=>handleRegEdit(row.tag,'fPres',e.target.value)}/></td>
                                            <td><input disabled={userRole!=='admin'} type="date" className="input-edit" value={row.fechaDev} onChange={e=>handleRegEdit(row.tag,'fDev',e.target.value)}/></td>
                                            <td>{row.estadoDoc}</td>
                                            <td>{row.ubicacion}</td>
                                            <td><select disabled={userRole!=='admin'} className="select-edit" value={row.montado} onChange={e=>handleRegEdit(row.tag,'montado',e.target.value)}><option value="SIN MONTAR">SIN MONTAR</option><option value="MONTADO">MONTADO</option></select></td>
                                        </tr>
                                    ))}
                                </tbody></table></div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'systems' && (
                        <div className="grid grid-cols-1 gap-6 animate-enter">
                            <div className="bg-white p-4 rounded-lg shadow"><h3 className="font-bold">Iniciados: {startedSubsystems}</h3></div>
                            {systemsStats.map((sys, i) => (
                                <div key={i} className="bg-white rounded shadow p-4 mb-2">
                                    <div className="flex justify-between font-bold" onClick={()=>toggleRow(sys.id)}><span>{sys.sistema}</span><span>{sys.percent}%</span></div>
                                    {expandedRows[sys.id] && (
                                        <table className="w-full text-xs mt-2"><thead><tr><th>Tag</th><th>Skid</th><th>Alm</th><th>Reg</th><th>Est</th></tr></thead>
                                            <tbody>{sys.tags.map((t, j) => <TagEditRow key={j} tagItem={t} onEdit={handleTagEdit} skidOptions={skidOptions} almacenOptions={almacenOptions} readOnly={userRole!=='admin'}/>)}</tbody>
                                        </table>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<InstrumentDashboard />);
    </script>
</body>
</html>