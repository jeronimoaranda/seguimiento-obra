<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Instrumentación & Precom - Batería Petróleo (Online)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Libraries -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0",
                "lucide-react": "https://esm.sh/lucide-react@0.330.0?deps=react@18.2.0,react-dom@18.2.0",
                "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .input-edit:disabled, .select-edit:disabled { background-color: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; cursor: not-allowed; }
        .input-edit { border: 1px solid #e2e8f0; border-radius: 4px; padding: 2px 6px; width: 100%; font-size: 0.75rem; color: #334155; }
        .select-edit { border: 1px solid #e2e8f0; border-radius: 4px; padding: 2px; font-size: 0.75rem; background-color: white; width: 100%; cursor: pointer; }
        .animate-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useMemo, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, PieChart, Pie, Cell, ResponsiveContainer, Label, LabelList } from 'recharts';
        import { AlertCircle, CheckCircle, Clock, Activity, Upload, Trash2, HardHat, Download, X, AlertTriangle, Target, Layers, FileSpreadsheet, LayoutDashboard, ChevronDown, ChevronRight, Boxes, PlayCircle, Wrench, Zap, Hammer, FileWarning, Package, Truck, ClipboardCheck, Edit3, Save, Eye, EyeOff, FileCheck, RefreshCw, CalendarDays, Search, FileText, MapPin, Box, LogIn, User, Shield, LogOut, Database, Settings, XCircle } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, collection, writeBatch, getDocs, query, orderBy } from "firebase/firestore";

        // --- CONFIG ---
        const getFirebaseConfig = () => ({
            config: {
                apiKey: "AIzaSyCon3w6IFtCGpwPi25e8dwFRU_R0CzQmjc",
                authDomain: "tablero-de-control---obra.firebaseapp.com",
                projectId: "tablero-de-control---obra",
                storageBucket: "tablero-de-control---obra.firebasestorage.app",
                messagingSenderId: "838434221051",
                appId: "1:838434221051:web:0c599f2734f613c7c6f95e",
                measurementId: "G-H034T2EXR5"
            },
            appId: "tablero-de-control---obra", 
            isConfigured: true 
        });

        // --- UTILS ---
        const CHUNK_SIZE = 800000;
        const chunkString = (str, len) => { const s = Math.ceil(str.length/len); const r = Array(s); let o=0; for(let i=0;i<s;i++){ r[i]=str.substr(o,len); o+=len; } return r; };
        const saveLargeData = async (db, appId, cName, dataStr) => {
            const c = chunkString(dataStr, CHUNK_SIZE); const b = writeBatch(db); const col = collection(db,'artifacts',appId,'public','data',cName);
            c.forEach((ch,i) => b.set(doc(col,i.toString()), {data:ch})); await b.commit(); return c.length;
        };
        const fetchLargeData = async (db, appId, cName, tot) => {
            if(!tot) return []; const q = query(collection(db,'artifacts',appId,'public','data',cName)); const s = await getDocs(q);
            const c = []; s.forEach(d => { const i = parseInt(d.id); if(!isNaN(i) && i<tot) c[i] = d.data().data; }); return JSON.parse(c.join(""));
        };
        const cleanStr = (s) => s ? s.toString().trim() : "";
        const safeParseInt = (v) => { const p = parseInt(cleanStr(v), 10); return isNaN(p) ? 0 : p; };
        const normalizeDate = (d) => {
            if(!d || typeof d !== 'string') return ""; const c = d.trim();
            const m = c.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if(m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
            if(c.match(/^\d{4}-\d{2}-\d{2}$/)) return c; return ""; 
        };
        const parseCSVLine = (text, delimiter) => {
            const result = []; let current = ''; let inQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') inQuote = !inQuote;
                else if (char === delimiter && !inQuote) { result.push(current); current = ''; }
                else current += char;
            }
            result.push(current); return result.map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"').trim());
        };
        const COLORS = { blue: "#3b82f6", green: "#10b981", orange: "#f97316", red: "#ef4444", yellow: "#eab308", purple: "#a855f7", indigo: "#6366f1", gray: "#64748b", teal: "#14b8a6", pink: "#db2777", cyan: "#06b6d4" };
        const COLORS_LIST = Object.values(COLORS);
        const FilterIconSvg = ({ size=14, fill="none", className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        );

        // --- COMPONENTES UI INDEPENDIENTES (Evita ReferenceErrors) ---

        const TableFilter = ({ columnKey, data, currentFilter, onFilterChange, title }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            
            const uniqueValues = useMemo(() => {
                const values = new Set();
                if (Array.isArray(data)) data.forEach(item => values.add(item[columnKey] ? String(item[columnKey]) : "(Vacío)"));
                return Array.from(values).sort();
            }, [data, columnKey]);

            const filteredValues = uniqueValues.filter(v => v.toLowerCase().includes(searchTerm.toLowerCase()));
            const [tempSelected, setTempSelected] = useState(new Set(currentFilter || []));

            useEffect(() => { if (isOpen) { setTempSelected(new Set(currentFilter || [])); setSearchTerm(""); } }, [isOpen, currentFilter]);

            const handleApply = () => { onFilterChange(columnKey, tempSelected.size > 0 ? Array.from(tempSelected) : null); setIsOpen(false); };
            const toggleValue = (val) => { const n = new Set(tempSelected); if (n.has(val)) n.delete(val); else n.add(val); setTempSelected(n); };

            const isActive = currentFilter && currentFilter.length > 0;

            return (
                <div className="flex items-center justify-between gap-1 relative group">
                    <span className="truncate cursor-pointer hover:text-blue-600" onClick={(e)=>{e.stopPropagation(); setIsOpen(!isOpen)}}>{title}</span>
                    <button onClick={(e) => { e.stopPropagation(); setIsOpen(!isOpen); }} className={`p-1 rounded hover:bg-slate-200 transition-colors ${isActive ? 'text-blue-600 bg-blue-50' : 'text-slate-400 opacity-0 group-hover:opacity-100 focus:opacity-100'}`}>
                        <FilterIconSvg size={14} fill={isActive ? "currentColor" : "none"} />
                    </button>
                    {isOpen && (
                        <>
                            <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)}></div>
                            <div className="absolute top-full right-0 mt-1 w-56 bg-white rounded-lg shadow-xl border border-slate-200 z-50 p-3 text-left font-normal normal-case">
                                <input type="text" placeholder="Buscar..." className="w-full px-2 py-1 text-xs border rounded mb-2 focus:border-blue-500 outline-none text-slate-700" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <div className="flex justify-between mb-2 text-[10px]"><button onClick={()=>setTempSelected(new Set(filteredValues))} className="text-blue-600 hover:underline">Todos</button><button onClick={()=>setTempSelected(new Set())} className="text-slate-500 hover:underline">Ninguno</button></div>
                                <div className="max-h-40 overflow-y-auto mb-3 border rounded p-1 bg-slate-50">
                                    {filteredValues.map(val => (
                                        <label key={val} className="flex items-center gap-2 p-1 hover:bg-slate-100 rounded cursor-pointer text-xs text-slate-600">
                                            <input type="checkbox" checked={tempSelected.has(val)} onChange={() => toggleValue(val)} className="rounded text-blue-600" />
                                            <span className="truncate">{val}</span>
                                        </label>
                                    ))}
                                    {filteredValues.length === 0 && <div className="text-xs text-slate-400 p-2 text-center">Sin resultados</div>}
                                </div>
                                <div className="flex justify-end gap-2"><button onClick={() => setIsOpen(false)} className="px-2 py-1 text-xs bg-gray-100 rounded">Cancelar</button><button onClick={handleApply} className="px-2 py-1 text-xs bg-blue-600 text-white rounded">Aplicar</button></div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const MetricCard = ({ title, value, icon: Icon, color, subtext, percentage, compact }) => (
            <div className="bg-white p-4 rounded-lg shadow-sm border-l-4 relative overflow-hidden group hover:shadow-md transition-all" style={{ borderLeftColor: color }}>
                <div className="flex justify-between items-center z-10 relative">
                    <div>
                        <p className="text-slate-400 text-xs font-bold uppercase tracking-wider">{title}</p>
                        <h3 className={`${compact ? 'text-lg' : 'text-xl'} font-bold text-slate-700 flex items-baseline gap-2 mt-1`}>{value} {percentage && <span className="text-xs font-normal text-slate-400">({percentage}%)</span>}</h3>
                    </div>
                    <div className={`p-2 rounded-full bg-opacity-10 group-hover:scale-110 transition-transform`} style={{ backgroundColor: `${color}20` }}><Icon size={compact ? 20 : 24} color={color} /></div>
                </div>
                {percentage && <div className="w-full bg-slate-100 rounded-full h-1.5 mt-3"><div className="h-1.5 rounded-full transition-all duration-500" style={{ width: `${percentage}%`, backgroundColor: color }}></div></div>}
                {subtext && <p className="text-xs text-slate-400 mt-2 z-10 relative">{subtext}</p>}
            </div>
        );

        const ProgressBar = ({ current, total, color = "bg-blue-600" }) => {
            const percent = total > 0 ? Math.min(100, (current / total) * 100) : 0;
            return (<div className="w-full bg-slate-200 rounded-full h-2 mt-1"><div className={`h-2 rounded-full transition-all duration-500 ${color}`} style={{ width: `${percent}%` }}></div></div>);
        };

        const ExpandableRow = ({ sys, isExpanded, onToggle, onEdit, skidOptions, almacenOptions, isReadOnly }) => {
            const groupedTags = useMemo(() => {
                const groups = {};
                sys.tags.forEach(t => { const spec = t.specialty || "Sin Especialidad"; if (!groups[spec]) groups[spec] = []; groups[spec].push(t); });
                return groups;
            }, [sys.tags]);

            return (
                <React.Fragment>
                    <tr className={`bg-white hover:bg-blue-50 transition-colors border-b border-slate-100 cursor-pointer ${isExpanded ? 'bg-slate-50 border-l-4 border-l-blue-500' : ''}`} onClick={onToggle}>
                        <td className="px-6 py-4"><div className="flex items-center gap-2 text-slate-500">{isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}<span className="font-medium text-slate-800 text-sm">{sys.sistema}</span></div><div className="text-xs text-slate-400 pl-6">{sys.descSistema}</div></td>
                        <td className="px-6 py-4"><div className="font-medium text-slate-700 text-sm">{sys.subsistema}</div><div className="text-xs text-slate-400">{sys.descSubsistema}</div></td>
                        <td className="px-6 py-4 text-center font-bold text-slate-700 text-sm">{sys.totalTags}</td>
                        <td className="px-6 py-4 text-center"><span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${sys.mountedTags > 0 ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-500'}`}>{sys.mountedTags}</span></td>
                        <td className="px-6 py-4"><div className="flex items-center gap-3"><span className="text-xs font-bold w-8 text-right">{sys.percent}%</span><ProgressBar current={sys.mountedTags} total={sys.totalTags} color={parseFloat(sys.percent) === 100 ? 'bg-green-600' : parseFloat(sys.percent) > 50 ? 'bg-blue-600' : 'bg-orange-400'} /></div></td>
                    </tr>
                    {isExpanded && (
                        <tr>
                            <td colSpan="5" className="p-4 bg-slate-50 border-b border-slate-200 shadow-inner">
                                <div className="pl-6">
                                    {Object.keys(groupedTags).sort().map(specName => (
                                        <div key={specName} className="border border-slate-200 rounded mb-2 overflow-hidden bg-white shadow-sm">
                                            <div className="flex justify-between items-center p-2 px-3 bg-slate-50">
                                                <span className="font-bold text-slate-700 text-xs flex items-center gap-2">{specName}</span>
                                                <span className="text-[10px] text-slate-500 font-medium">{groupedTags[specName].filter(t => t.calculatedStatus === "INSTALADO").length}/{groupedTags[specName].length} Inst.</span>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-[10px] text-left">
                                                    <thead className="bg-slate-100 text-slate-500 uppercase border-y border-slate-200">
                                                        <tr><th className="px-4 py-2">TAG</th><th className="px-4 py-2">Desc.</th><th className="px-2 py-2">Skid</th><th className="px-2 py-2">Almacén</th><th className="px-2 py-2">Calib?</th><th className="px-2 py-2">R. Tot</th><th className="px-2 py-2">R. Real</th><th className="px-2 py-2">Estado</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        {groupedTags[specName].map((tagItem) => {
                                                            let rowColor = "hover:bg-slate-50";
                                                            if (tagItem.calculatedStatus === "INSTALADO") rowColor = "bg-green-50/60";
                                                            else if (tagItem.calculatedStatus === "EN PROCESO") rowColor = "bg-yellow-50/60";
                                                            return (
                                                                <tr key={tagItem.tag} className={`border-b border-slate-100 transition-colors ${rowColor}`}>
                                                                    <td className="px-4 py-2 font-medium text-slate-800 w-32">{tagItem.tag}</td>
                                                                    <td className="px-4 py-2 text-slate-500 truncate max-w-[150px]" title={tagItem.desc}>{tagItem.desc}</td>
                                                                    <td className="px-2 py-1"><select disabled={isReadOnly} className="select-edit" value={tagItem.skid} onChange={(e) => onEdit(tagItem.tag, 'skid', e.target.value)}><option value="">-</option>{skidOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></td>
                                                                    <td className="px-2 py-1"><select disabled={isReadOnly} className="select-edit" value={tagItem.almacen} onChange={(e) => onEdit(tagItem.tag, 'almacen', e.target.value)}><option value="">-</option>{almacenOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></td>
                                                                    <td className="px-2 py-1"><select disabled={isReadOnly} className="select-edit text-center" value={tagItem.aCalibrar} onChange={(e) => onEdit(tagItem.tag, 'aCalibrar', e.target.value)}><option value="0">NO</option><option value="1">SI</option></select></td>
                                                                    <td className="px-2 py-1"><input disabled={isReadOnly} type="number" className="input-edit text-center" value={tagItem.cantRegTot} onChange={(e) => onEdit(tagItem.tag, 'cantRegTot', e.target.value)} /></td>
                                                                    <td className="px-2 py-1"><input disabled={isReadOnly} type="number" className="input-edit text-center" value={tagItem.cantRegReal} onChange={(e) => onEdit(tagItem.tag, 'cantRegReal', e.target.value)} /></td>
                                                                    <td className="px-2 py-1 text-center"><span className={`text-[10px] font-bold px-2 py-1 rounded border ${tagItem.calculatedStatus === 'INSTALADO' ? 'text-green-700 bg-green-100 border-green-200' : tagItem.calculatedStatus === 'EN PROCESO' ? 'text-yellow-700 bg-yellow-100 border-yellow-200' : 'text-slate-400 bg-slate-100 border-slate-200'}`}>{tagItem.calculatedStatus}</span></td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </td>
                        </tr>
                    )}
                </React.Fragment>
            );
        };

        const LoginScreen = ({ onLogin, loading, isConfigured }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const handleSubmit = (e) => { e.preventDefault(); if(!isConfigured || !email || !password) return; onLogin({ email, password, isRegistering }); };
            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                        <h2 className="text-xl font-bold text-slate-700 mb-6 text-center">Control de Obra</h2>
                        {!isConfigured && <div className="bg-yellow-50 p-2 text-xs mb-4 text-yellow-800">Falta configuración Firebase</div>}
                        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-2 border rounded" placeholder="usuario@obra.com" />
                            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-2 border rounded" placeholder="••••••••" />
                            <div className="flex items-center gap-2"><input type="checkbox" checked={isRegistering} onChange={e => setIsRegistering(e.target.checked)} /><label className="text-xs">Crear cuenta nueva</label></div>
                            <button disabled={loading || !isConfigured} type="submit" className="mt-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 flex justify-center items-center gap-2">{loading ? <RefreshCw className="animate-spin"/> : <LogIn size={18} />}{isRegistering ? 'Registrar' : 'Entrar'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const ApprovalModal = ({ isOpen, onClose, onConfirm, changes }) => {
            if (!isOpen || !changes) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-bold mb-4">Confirmar Carga</h3>
                        <div className="bg-slate-50 p-4 mb-4 text-sm rounded">
                             <p>Total: <strong>{changes.total}</strong> | Nuevos: <strong className="text-green-600">+{changes.newItems}</strong> | Modif: <strong className="text-orange-600">~{changes.modified}</strong></p>
                        </div>
                        <div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 bg-gray-100 rounded">Cancelar</button><button onClick={onConfirm} className="px-4 py-2 bg-blue-600 text-white rounded">Confirmar</button></div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function InstrumentDashboard() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState('viewer');
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [loadingData, setLoadingData] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [matrixData, setMatrixData] = useState([]);
            const [regData, setRegData] = useState([]);
            const [activeTab, setActiveTab] = useState("dashboard");
            const [filter, setFilter] = useState("TODOS");
            const [columnFilters, setColumnFilters] = useState({});
            const [expandedRows, setExpandedRows] = useState({});
            const [manualEdits, setManualEdits] = useState({});
            const [uploadStats, setUploadStats] = useState(null);
            const [isApprovalModalOpen, setIsApprovalModalOpen] = useState(false);
            const [pendingData, setPendingData] = useState(null);
            const [changeStats, setChangeStats] = useState(null);
            const [hideDeleted, setHideDeleted] = useState(true);
            const [showExportMenu, setShowExportMenu] = useState(false);
            
            const fileInputRef = useRef(null);
            const regInputRef = useRef(null);

            // Firebase Config
            const { config, appId, isConfigured } = useMemo(() => getFirebaseConfig(), []);
            const app = useMemo(() => isConfigured ? initializeApp(config) : null, [config, isConfigured]);
            const auth = useMemo(() => app ? getAuth(app) : null, [app]);
            const db = useMemo(() => app ? getFirestore(app) : null, [app]);

            // Data Processing
            const flatData = useMemo(() => regData.map(item => {
                let status = "PENDIENTE";
                if (item.fDev && item.fDev.trim() !== "") status = "FINALIZADO";
                else if (item.fPres && item.fPres.trim() !== "") status = "EN INSPECCIÓN";
                else if (item.fGen && item.fGen.trim() !== "") status = "EN LABORATORIO";
                else if (item.fCalib && item.fCalib.trim() !== "") status = "CALIBRADO";
                return {
                    ...item,
                    ubicacionFisica: item.ubicacion || "Sin Dato",
                    ubicacionRegistro: item.ubicReg || "PENDIENTE",
                    proveedor: item.lab || "Sin Prov.",
                    estadoDoc: status,
                    fechaGen: item.fGen, fechaPres: item.fPres, fechaDev: item.fDev
                };
            }), [regData]);

            // Unique lists for dropdowns
            const uniqueLabs = useMemo(() => Array.from(new Set(regData.map(d => d.lab))).filter(Boolean).sort(), [regData]);
            const uniqueLocations = useMemo(() => Array.from(new Set(regData.map(d => d.ubicacion))).filter(Boolean).sort(), [regData]);
            const uniqueProvisions = useMemo(() => Array.from(new Set(regData.map(d => d.provision))).filter(Boolean).sort(), [regData]);
            const skidOptions = useMemo(() => Array.from(new Set(matrixData.map(d => d.skid?.trim()))).filter(Boolean).sort(), [matrixData]);
            const almacenOptions = useMemo(() => { const s = new Set(matrixData.map(d => d.almacen?.trim()).filter(Boolean)); s.add("EN OBRA"); return Array.from(s).sort(); }, [matrixData]);

            // Filter Logic
            const filteredList = useMemo(() => {
                let data = filter === "TODOS" ? flatData : flatData.filter(d => d.estadoDoc === filter || d.ubicacion === filter);
                Object.keys(columnFilters).forEach(key => {
                    const selected = columnFilters[key];
                    if (selected && selected.length > 0) data = data.filter(item => selected.includes(item[key] ? String(item[key]) : "(Vacío)"));
                });
                return data;
            }, [flatData, filter, columnFilters]);

            // KPI Stats
            const specialtyStats = useMemo(() => {
                const stats = { "I":{label:"Instrumentación", total:0, completed:0, color:"#3b82f6", icon:Activity}, "E":{label:"Electricidad", total:0, completed:0, color:"#eab308", icon:Zap}, "P":{label:"Piping", total:0, completed:0, color:"#6366f1", icon:Target}, "M":{label:"Mecánica", total:0, completed:0, color:"#64748b", icon:Wrench}, "C":{label:"Civil", total:0, completed:0, color:"#f97316", icon:Hammer} };
                matrixData.forEach(item => {
                    if((item.estado1||"").toUpperCase().includes("ELIMINA")) return;
                    const spec = (item.especialidad||"").toUpperCase();
                    let key = null;
                    if(spec.includes("INSTRUMENT") || spec.includes("(I)")) key="I";
                    else if(spec.includes("ELECTRIC") || spec.includes("(E)")) key="E";
                    else if(spec.includes("PIPING") || spec.includes("(P)")) key="P";
                    else if(spec.includes("MEC") || spec.includes("(M)")) key="M";
                    else if(spec.includes("CIVIL") || spec.includes("(C)")) key="C";
                    
                    if(key) {
                        const edit = manualEdits[item.tag];
                        stats[key].total += safeParseInt(edit?.cantRegTot !== undefined ? edit.cantRegTot : item.cantRegTot);
                        stats[key].completed += safeParseInt(edit?.cantRegReal !== undefined ? edit.cantRegReal : item.cantRegReal);
                    }
                });
                return Object.values(stats);
            }, [matrixData, manualEdits]);

            const systemsStats = useMemo(() => {
                const grouped = {};
                const filteredMatrix = hideDeleted ? matrixData.filter(i => !(i.estado1||"").toUpperCase().includes("ELIMINA")) : matrixData;
                
                filteredMatrix.forEach(item => {
                    const edit = manualEdits[item.tag];
                    const tot = safeParseInt(edit?.cantRegTot !== undefined ? edit.cantRegTot : item.cantRegTot);
                    const real = safeParseInt(edit?.cantRegReal !== undefined ? edit.cantRegReal : item.cantRegReal);
                    let state = "PENDIENTE";
                    if(tot>0 && real>=tot) state="INSTALADO"; else if(real>0) state="EN PROCESO";

                    const key = `${item.sistema}-${item.subsistema}`;
                    if (!grouped[key]) grouped[key] = { id: key, sistema: item.sistema, descSistema: item.descSistema, subsistema: item.subsistema, descSubsistema: item.descSubsistema, totalTags: 0, mountedTags: 0, tags: [] };
                    
                    grouped[key].totalTags++;
                    if(state === "INSTALADO") grouped[key].mountedTags++;
                    grouped[key].tags.push({ ...item, calculatedStatus: state, ...edit });
                });
                return Object.values(grouped).sort((a,b) => a.sistema.localeCompare(b.sistema));
            }, [matrixData, manualEdits, hideDeleted]);

            // Auth & Data Loading Effects
            useEffect(() => {
                if(!auth) { setLoadingAuth(false); return; }
                const unsub = onAuthStateChanged(auth, u => {
                    setUser(u); setLoadingAuth(false);
                    if(u) setRole(u.email?.toLowerCase().startsWith('admin') ? 'admin' : 'viewer');
                });
                return () => unsub();
            }, [auth]);

            useEffect(() => {
                if(!user || !db) return;
                setLoadingData(true);
                const unsub = onSnapshot(doc(db,'artifacts',appId,'public','data','app_metadata','main'), async (snap) => {
                    if(snap.exists()){
                        const d = snap.data();
                        if(d.edits) setManualEdits(JSON.parse(d.edits));
                        if(d.matrixChunkCount>0) try { setMatrixData(await fetchLargeData(db, appId, 'matrix_chunks', d.matrixChunkCount)); } catch(e){console.error(e);} else setMatrixData([]);
                        if(d.registryChunkCount>0) try { setRegData(await fetchLargeData(db, appId, 'registry_chunks', d.registryChunkCount)); } catch(e){console.error(e);} else setRegData([]);
                    }
                    setLoadingData(false);
                });
                return () => unsub();
            }, [user, db, appId]);

            // Actions
            const saveToCloud = async (nm, nr, ne) => {
                if(role!=='admin' || !db) return;
                setIsSaving(true);
                try {
                    const fm = nm || matrixData; const fr = nr || regData; const fe = ne || manualEdits;
                    let mc = 0, rc = 0;
                    if(nm) mc = await saveLargeData(db, appId, 'matrix_chunks', JSON.stringify(fm));
                    if(nr) rc = await saveLargeData(db, appId, 'registry_chunks', JSON.stringify(fr));
                    
                    const payload = { edits: JSON.stringify(fe), lastUpdated: new Date().toISOString(), updatedBy: user.email };
                    if(nm) payload.matrixChunkCount = mc;
                    if(nr) payload.registryChunkCount = rc;
                    
                    await setDoc(doc(db,'artifacts',appId,'public','data','app_metadata','main'), payload, {merge:true});
                } catch(e) { alert("Error: "+e.message); } finally { setIsSaving(false); }
            };

            const handleLogin = async (c) => {
                setLoadingAuth(true);
                try {
                    if(c.isRegistering) await createUserWithEmailAndPassword(auth, c.email, c.password);
                    else await signInWithEmailAndPassword(auth, c.email, c.password);
                } catch(e) { alert(e.message); } finally { setLoadingAuth(false); }
            };

            const handleUpload = (e, type) => {
                const file = e.target.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const rows = parseCSVLine(ev.target.result.replace(/\r/g,''),'\n').filter(l=>l.length>0); // Quick split
                    const headers = parseCSVLine(rows[0], rows[0].includes(';')?';':',').map(h=>h.toUpperCase());
                    const del = rows[0].includes(';')?';':',';
                    const data = [];
                    
                    // Simple parser mapping
                    rows.slice(1).forEach(row => {
                        const cols = parseCSVLine(row, del);
                        if(type === 'matrix') {
                             // Logic to map Matrix columns (Simplified for brevity but functional)
                             const getIdx = (n) => headers.findIndex(h => h.includes(n));
                             data.push({
                                 tag: cols[headers.indexOf('TAG')],
                                 especialidad: cols[getIdx('ESPECIALIDAD')] || "",
                                 descripcion: cols[getIdx('DESCRIPCION')] || "",
                                 sistema: cols[getIdx('SISTEMA')] || "", descSistema: "",
                                 subsistema: cols[getIdx('SUB')] || "", descSubsistema: "",
                                 skid: cols[headers.indexOf('SKID')] || "",
                                 almacen: cols[getIdx('ALMACEN')] || "",
                                 cantRegTot: cols[getIdx('CANTREG')] || "0",
                                 cantRegReal: "0", estado1: "", estado2: ""
                             });
                        } else {
                            // Logic to map Registry columns
                            data.push({
                                tag: cols[headers.indexOf('TAG')],
                                skid: cols[headers.indexOf('SKID')] || "",
                                ubicacion: cols[headers.findIndex(h=>h.includes('UBICA') && !h.includes('REG'))] || "",
                                lab: cols[headers.findIndex(h=>h.includes('LAB'))] || "",
                                fCalib: normalizeDate(cols[headers.findIndex(h=>h.includes('CALIB'))]),
                                fGen: normalizeDate(cols[headers.findIndex(h=>h.includes('GENER'))]),
                                fPres: normalizeDate(cols[headers.findIndex(h=>h.includes('PRES'))]),
                                fDev: normalizeDate(cols[headers.findIndex(h=>h.includes('DEVOL'))]),
                                ubicReg: cols[headers.findIndex(h=>h.includes('REGISTRO'))] || "",
                                montado: cols[headers.indexOf('MONTADO')] || "",
                                provision: cols[headers.indexOf('PROVISION')] || ""
                            });
                        }
                    });
                    
                    setPendingData(data);
                    setChangeStats({ total: data.length, newItems: 0, modified: 0 }); // Simplified diff
                    setIsApprovalModalOpen(true);
                };
                reader.readAsText(file);
            };

            const confirmMatrixLoad = () => {
                // Determine if it was matrix or registry based on data structure (hacky but works for unified modal)
                if(pendingData[0]?.especialidad !== undefined) {
                    setMatrixData(pendingData);
                    saveToCloud(pendingData, null, {});
                } else {
                    setRegData(pendingData);
                    saveToCloud(null, pendingData, null);
                }
                setIsApprovalModalOpen(false);
            };

            const handleRegUpdate = (tag, field, val) => {
                if(role!=='admin') return;
                const newData = regData.map(r => {
                    if(r.tag === tag) {
                        // Cascada de fechas
                        if(field === 'fCalib' && !val) return { ...r, fCalib: "", fGen: "", fPres: "", fDev: "", estadoDoc: "PENDIENTE" };
                        if(field === 'fGen' && !val) return { ...r, fGen: "", fPres: "", fDev: "", estadoDoc: "CALIBRADO" };
                        // ... logic continue
                        return { ...r, [field]: val };
                    }
                    return r;
                });
                setRegData(newData);
                saveToCloud(null, newData, null);
            };

            if(!user) return <LoginScreen onLogin={handleLogin} loading={loadingAuth} isConfigured={isConfigured} />;

            return (
                <div className="min-h-screen bg-slate-50 p-6 font-sans">
                     <ApprovalModal isOpen={isApprovalModalOpen} onClose={()=>setIsApprovalModalOpen(false)} onConfirm={confirmMatrixLoad} changes={changeStats} />
                     
                     {/* Header & Tabs */}
                     <div className="flex flex-col gap-4 mb-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded shadow-sm">
                            <h1 className="text-xl font-bold">Control de Obra</h1>
                            <div className="flex gap-2">
                                <button onClick={()=>setHideDeleted(!hideDeleted)} className="px-3 py-1 bg-slate-100 rounded text-sm">{hideDeleted ? 'Ver Eliminados' : 'Ocultar Eliminados'}</button>
                                <button onClick={()=>setColumnFilters({})} className="px-3 py-1 bg-red-100 text-red-600 rounded text-sm flex items-center gap-1"><XCircle size={14}/> Borrar Filtros</button>
                                {role==='admin' && (
                                    <>
                                        <input type="file" ref={regInputRef} hidden onChange={(e)=>handleUpload(e, 'registry')} />
                                        <button onClick={()=>regInputRef.current.click()} disabled={isSaving} className="px-3 py-1 bg-blue-600 text-white rounded text-sm">Cargar Registros</button>
                                    </>
                                )}
                                <button onClick={()=>signOut(auth)} className="px-3 py-1 text-red-500 text-sm">Salir</button>
                            </div>
                        </div>
                        <div className="flex gap-4 border-b border-slate-200">
                             <button onClick={()=>setActiveTab('dashboard')} className={`pb-2 ${activeTab==='dashboard'?'border-b-2 border-blue-600 font-bold':''}`}>Registros</button>
                             <button onClick={()=>setActiveTab('systems')} className={`pb-2 ${activeTab==='systems'?'border-b-2 border-blue-600 font-bold':''}`}>Sistemas ABM</button>
                        </div>
                     </div>

                     {/* VISTAS */}
                     {activeTab === 'dashboard' && (
                         <div>
                             {/* KPIS */}
                             <div className="grid grid-cols-5 gap-4 mb-6">
                                 {specialtyStats.map(s => <MetricCard key={s.label} title={s.label} value={`${s.completed}/${s.total}`} color={s.color} icon={s.icon} percentage={s.total>0?(s.completed/s.total*100).toFixed(0):0} compact />)}
                             </div>
                             
                             {/* TABLA PRINCIPAL */}
                             <div className="bg-white shadow rounded overflow-auto h-[600px]">
                                 <table className="w-full text-xs text-left">
                                     <thead className="bg-slate-100 sticky top-0 z-10">
                                         <tr>
                                             <th className="p-2"><TableFilter title="TAG" columnKey="tag" data={flatData} currentFilter={columnFilters.tag} onFilterChange={handleColumnFilterChange}/></th>
                                             <th className="p-2 w-24"><TableFilter title="Lab" columnKey="proveedor" data={flatData} currentFilter={columnFilters.proveedor} onFilterChange={handleColumnFilterChange}/></th>
                                             <th className="p-2 w-24">Calibración</th>
                                             <th className="p-2 w-24">Generado</th>
                                             <th className="p-2 w-24">Presentado</th>
                                             <th className="p-2 w-24">Devolución</th>
                                             <th className="p-2 w-32"><TableFilter title="Estado" columnKey="estadoDoc" data={flatData} currentFilter={columnFilters.estadoDoc} onFilterChange={handleColumnFilterChange}/></th>
                                         </tr>
                                     </thead>
                                     <tbody>
                                         {filteredList.map(row => (
                                             <tr key={row.tag} className="border-b hover:bg-slate-50">
                                                 <td className="p-2 font-medium">{row.tag}</td>
                                                 <td className="p-2">
                                                     <select disabled={role!=='admin'} className="w-full border rounded" value={row.proveedor} onChange={(e)=>handleRegUpdate(row.tag,'lab',e.target.value)}>
                                                         <option value="">-</option>{uniqueLabs.map(l=><option key={l} value={l}>{l}</option>)}
                                                     </select>
                                                 </td>
                                                 <td className="p-2"><input type="date" disabled={role!=='admin'} className="w-full border rounded" value={row.fCalib||''} onChange={(e)=>handleRegUpdate(row.tag,'fCalib',e.target.value)} /></td>
                                                 <td className="p-2"><input type="date" disabled={role!=='admin' || !row.fCalib} className={`w-full border rounded ${!row.fCalib?'bg-gray-100':''}`} value={row.fechaGen||''} onChange={(e)=>handleRegUpdate(row.tag,'fGen',e.target.value)} /></td>
                                                 <td className="p-2"><input type="date" disabled={role!=='admin' || !row.fechaGen} className={`w-full border rounded ${!row.fechaGen?'bg-gray-100':''}`} value={row.fechaPres||''} onChange={(e)=>handleRegUpdate(row.tag,'fPres',e.target.value)} /></td>
                                                 <td className="p-2"><input type="date" disabled={role!=='admin' || !row.fechaPres} className={`w-full border rounded ${!row.fechaPres?'bg-gray-100':''}`} value={row.fechaDev||''} onChange={(e)=>handleRegUpdate(row.tag,'fDev',e.target.value)} /></td>
                                                 <td className="p-2"><span className={`px-2 py-0.5 rounded text-[10px] font-bold ${row.estadoDoc==='FINALIZADO'?'bg-green-100 text-green-700':'bg-yellow-100'}`}>{row.estadoDoc}</span></td>
                                             </tr>
                                         ))}
                                     </tbody>
                                 </table>
                             </div>
                         </div>
                     )}

                     {activeTab === 'systems' && (
                         <div className="bg-white shadow rounded p-4">
                             <h3 className="font-bold mb-4">Avance por Subsistemas</h3>
                             {systemsStats.map(sys => (
                                 <ExpandableRow key={sys.id} sys={sys} isExpanded={expandedRows[sys.id]} onToggle={()=>toggleRow(sys.id)} onEdit={handleTagEdit} skidOptions={skidOptions} almacenOptions={almacenOptions} isReadOnly={role!=='admin'} />
                             ))}
                         </div>
                     )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<InstrumentDashboard />);
    </script>
</body>
</html>