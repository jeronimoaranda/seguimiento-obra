<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Instrumentación & Precom - Batería Petróleo (Online)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Libraries -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0",
                "lucide-react": "https://esm.sh/lucide-react@0.330.0?deps=react@18.2.0,react-dom@18.2.0",
                "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
            }
        }
    </script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #64748b; font-weight: 500; }
        .tab-inactive:hover { color: #334155; }
        
        .input-edit:disabled, .select-edit:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            border-color: #e2e8f0;
            cursor: not-allowed;
        }

        .input-edit { border: 1px solid #e2e8f0; border-radius: 4px; padding: 2px 6px; width: 100%; font-size: 0.75rem; color: #334155; transition: all 0.2s; }
        .input-edit:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); background-color: #fff; }
        .select-edit { border: 1px solid #e2e8f0; border-radius: 4px; padding: 2px; font-size: 0.75rem; background-color: white; width: 100%; cursor: pointer; }
        .select-edit:focus { border-color: #3b82f6; outline: none; }
        
        input[type="date"] { cursor: pointer; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-slate-900">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useMemo, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, PieChart, Pie, Cell, ResponsiveContainer, Label, LabelList } from 'recharts';
        import { AlertCircle, CheckCircle, Clock, Activity, Upload, Trash2, HardHat, Download, X, AlertTriangle, Target, Layers, FileSpreadsheet, LayoutDashboard, ChevronDown, ChevronRight, Boxes, PlayCircle, Wrench, Zap, Hammer, FileWarning, Package, Truck, ClipboardCheck, Edit3, Save, Eye, EyeOff, FileCheck, RefreshCw, CalendarDays, Search, FileText, MapPin, Box, LogIn, User, Shield, LogOut, Database, Settings } from 'lucide-react';
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, collection, writeBatch, getDocs, query, orderBy } from "firebase/firestore";

        // --- CONFIGURACIÓN FIREBASE ---
        const getFirebaseConfig = () => {
            return {
                config: {
                    apiKey: "AIzaSyCon3w6IFtCGpwPi25e8dwFRU_R0CzQmjc",
                    authDomain: "tablero-de-control---obra.firebaseapp.com",
                    projectId: "tablero-de-control---obra",
                    storageBucket: "tablero-de-control---obra.firebasestorage.app",
                    messagingSenderId: "838434221051",
                    appId: "1:838434221051:web:0c599f2734f613c7c6f95e",
                    measurementId: "G-H034T2EXR5"
                },
                appId: "tablero-de-control---obra", 
                isConfigured: true 
            };
        };

        // --- HELPERS PARA FRAGMENTACIÓN (CHUNKING) ---
        const CHUNK_SIZE = 800000;

        const chunkString = (str, length) => {
            const size = Math.ceil(str.length / length);
            const r = Array(size);
            let offset = 0;
            for (let i = 0; i < size; i++) {
                r[i] = str.substr(offset, length);
                offset += length;
            }
            return r;
        };

        const saveLargeData = async (db, appId, collectionName, dataString) => {
            const chunks = chunkString(dataString, CHUNK_SIZE);
            const batch = writeBatch(db);
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', collectionName);
            chunks.forEach((chunk, index) => {
                const docRef = doc(colRef, index.toString());
                batch.set(docRef, { data: chunk });
            });
            await batch.commit();
            return chunks.length;
        };

        const fetchLargeData = async (db, appId, collectionName, totalChunks) => {
            if (!totalChunks || totalChunks === 0) return [];
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', collectionName);
            const q = query(colRef); 
            const querySnapshot = await getDocs(q);
            const chunks = [];
            querySnapshot.forEach((doc) => {
                const idx = parseInt(doc.id);
                if (!isNaN(idx) && idx < totalChunks) {
                    chunks[idx] = doc.data().data;
                }
            });
            return JSON.parse(chunks.join(""));
        };

        // --- FUNCIONES DE LIMPIEZA & UTILS ---
        const cleanStr = (str) => {
            if (!str) return "";
            return str.toString().trim();
        };

        const safeParseInt = (val) => {
            const parsed = parseInt(cleanStr(val), 10);
            return isNaN(parsed) ? 0 : parsed;
        };

        const normalizeDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return "";
            const clean = dateStr.trim();
            const match = clean.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = match[2].padStart(2, '0');
                const year = match[3];
                return `${year}-${month}-${day}`;
            }
            if (clean.match(/^\d{4}-\d{2}-\d{2}$/)) return clean;
            return ""; 
        };

        const parseCSVLine = (text, delimiter) => {
            const result = [];
            let current = '';
            let inQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuote = !inQuote;
                } else if (char === delimiter && !inQuote) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"').trim());
        };

        const COLORS = { blue: "#3b82f6", green: "#10b981", orange: "#f97316", red: "#ef4444", yellow: "#eab308", purple: "#a855f7", indigo: "#6366f1", gray: "#64748b", teal: "#14b8a6", pink: "#db2777", cyan: "#06b6d4" };
        const COLORS_LIST = Object.values(COLORS);

        // --- COMPONENTES UI (MODALES) ---
        const ConfirmModal = ({ isOpen, onClose, onConfirm }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                        <div className="flex items-center gap-3 mb-4 text-red-600"><AlertTriangle size={24} /><h3 className="text-lg font-bold">¿Limpiar Base de Datos?</h3></div>
                        <p className="text-gray-600 mb-6 text-sm">Se borrarán todos los datos para TODOS los usuarios.</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm">Cancelar</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm">Borrar Nube</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SuccessModal = ({ isOpen, onClose, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 animate-enter">
                        <div className="flex items-center gap-3 mb-4 text-green-600"><FileCheck size={24} /><h3 className="text-lg font-bold">Operación Exitosa</h3></div>
                        <p className="text-gray-600 mb-6 text-sm">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Aceptar</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ApprovalModal = ({ isOpen, onClose, onConfirm, changes }) => {
            if (!isOpen || !changes) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 animate-enter">
                        <div className="flex items-center gap-3 mb-4 text-blue-600"><RefreshCw size={24} /><h3 className="text-lg font-bold">Sincronizar con Nube</h3></div>
                        <p className="text-gray-600 mb-4 text-sm">Resumen de cambios a subir:</p>
                        <div className="bg-slate-50 p-4 rounded border border-slate-200 mb-6 text-sm">
                            <div className="flex justify-between mb-2"><span>Total Registros:</span> <strong>{changes.total}</strong></div>
                            <div className="flex justify-between mb-2 text-green-600"><span>Nuevos:</span> <strong>+{changes.newItems}</strong></div>
                            <div className="flex justify-between text-orange-600"><span>Modificados:</span> <strong>~{changes.modified}</strong></div>
                        </div>
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-sm">Cancelar</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm flex items-center gap-2"><Upload size={16}/> Subir a DB</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- LOGIN COMPONENT UNIFICADO ---
        const LoginScreen = ({ onLogin, loading, isConfigured }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                if(!isConfigured) {
                    setError('La aplicación no está configurada para conectarse a Firebase.');
                    return;
                }
                
                if (!email || !password) {
                    setError('Por favor complete todos los campos');
                    return;
                }
                
                onLogin({ email, password, isRegistering });
            };

            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col">
                        <div className="bg-blue-600 p-6 text-white text-center">
                            <h1 className="text-2xl font-bold mb-2">Control de Obra</h1>
                            <p className="text-blue-100 text-sm">Plataforma Colaborativa en Tiempo Real</p>
                        </div>
                        
                        {!isConfigured && (
                            <div className="bg-yellow-50 border-b border-yellow-200 p-4 text-yellow-800 text-xs">
                                <strong className="flex items-center gap-2 mb-1"><Settings size={14}/> Configuración Requerida</strong>
                                Para usar esta app fuera del editor (ej: GitHub), debes editar el archivo <code>index.html</code> y agregar tus credenciales de Firebase en la función <code>getFirebaseConfig</code>.
                            </div>
                        )}

                        <div className="p-8">
                            <h2 className="text-xl font-bold text-slate-700 mb-6 text-center">Iniciar Sesión</h2>

                            <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Email</label>
                                    <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none" placeholder="usuario@obra.com" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Contraseña</label>
                                    <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none" placeholder="••••••••" />
                                </div>
                                <div className="flex items-center gap-2 mt-1">
                                    <input type="checkbox" id="regCheck" checked={isRegistering} onChange={e => setIsRegistering(e.target.checked)} className="rounded text-blue-600"/>
                                    <label htmlFor="regCheck" className="text-xs text-slate-500 select-none">Crear cuenta nueva si no existe</label>
                                </div>

                                {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm flex items-center gap-2"><AlertCircle size={16}/> {error}</div>}

                                <button disabled={loading || !isConfigured} type="submit" className={`mt-4 py-2 rounded font-bold shadow-lg transform active:scale-95 transition-all flex justify-center items-center gap-2 ${!isConfigured ? 'bg-gray-300 cursor-not-allowed text-gray-500' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}>
                                    {loading ? <RefreshCw className="animate-spin"/> : <LogIn size={18} />}
                                    {isRegistering ? 'Registrar y Entrar' : 'Iniciar Sesión'}
                                </button>
                            </form>
                            
                            <div className="mt-6 text-xs text-center text-slate-400 border-t border-slate-100 pt-4">
                                <p>El sistema detectará automáticamente tu perfil (Admin/Visualizador) según tu correo.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MetricCard = ({ title, value, icon: Icon, color, subtext, percentage, compact }) => (
            <div className="bg-white p-4 rounded-lg shadow-sm border-l-4 relative overflow-hidden group hover:shadow-md transition-all" style={{ borderLeftColor: color }}>
                <div className="flex justify-between items-center z-10 relative">
                    <div>
                        <p className="text-slate-400 text-xs font-bold uppercase tracking-wider">{title}</p>
                        <h3 className={`${compact ? 'text-lg' : 'text-xl'} font-bold text-slate-700 flex items-baseline gap-2 mt-1`}>
                            {value}
                            {percentage && <span className="text-xs font-normal text-slate-400">({percentage}%)</span>}
                        </h3>
                    </div>
                    <div className={`p-2 rounded-full bg-opacity-10 group-hover:scale-110 transition-transform`} style={{ backgroundColor: `${color}20` }}>
                        <Icon size={compact ? 20 : 24} color={color} />
                    </div>
                </div>
                {subtext && <p className="text-xs text-slate-400 mt-2 z-10 relative">{subtext}</p>}
            </div>
        );

        const ProgressBar = ({ current, total, color = "bg-blue-600" }) => {
            const percent = total > 0 ? Math.min(100, (current / total) * 100) : 0;
            return (
                <div className="w-full bg-slate-200 rounded-full h-2 mt-1">
                    <div className={`h-2 rounded-full transition-all duration-500 ${color}`} style={{ width: `${percent}%` }}></div>
                </div>
            );
        };

        // --- COMPONENTES TABLA ---
        const TagEditRow = ({ tagItem, onEdit, skidOptions, almacenOptions, isReadOnly }) => {
            let rowColor = "hover:bg-slate-50";
            if (tagItem.calculatedStatus === "INSTALADO") rowColor = "bg-green-50/60";
            else if (tagItem.calculatedStatus === "EN PROCESO") rowColor = "bg-yellow-50/60";

            return (
                <tr className={`border-b border-slate-100 transition-colors ${rowColor}`}>
                    <td className="px-4 py-2 font-medium text-slate-800 w-32">{tagItem.tag}</td>
                    <td className="px-4 py-2 text-slate-500 text-[10px] truncate max-w-[150px]" title={tagItem.desc}>{tagItem.desc}</td>
                    
                    <td className="px-2 py-1">
                        <select disabled={isReadOnly} className="select-edit" value={tagItem.skid} onChange={(e) => onEdit(tagItem.tag, 'skid', e.target.value)}>
                            <option value="">-</option>
                            {skidOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    </td>
                    
                    <td className="px-2 py-1">
                        <select disabled={isReadOnly} className="select-edit" value={tagItem.almacen} onChange={(e) => onEdit(tagItem.tag, 'almacen', e.target.value)}>
                            <option value="">-</option>
                            {almacenOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    </td>
                    
                    <td className="px-2 py-1 text-center w-20">
                        <select disabled={isReadOnly} className="select-edit text-center" value={tagItem.aCalibrar} onChange={(e) => onEdit(tagItem.tag, 'aCalibrar', e.target.value)}>
                            <option value="0">NO</option>
                            <option value="1">SI</option>
                        </select>
                    </td>
                    
                    <td className="px-2 py-1 w-16"><input disabled={isReadOnly} type="number" className="input-edit text-center" value={tagItem.cantRegTot} onChange={(e) => onEdit(tagItem.tag, 'cantRegTot', e.target.value)} placeholder="0"/></td>
                    <td className="px-2 py-1 w-16"><input disabled={isReadOnly} type="number" className="input-edit text-center" value={tagItem.cantRegReal} onChange={(e) => onEdit(tagItem.tag, 'cantRegReal', e.target.value)} placeholder="0"/></td>

                    <td className="px-2 py-1 text-center w-32">
                         <span className={`text-[10px] font-bold px-2 py-1 rounded border ${tagItem.calculatedStatus === 'INSTALADO' ? 'text-green-700 bg-green-100 border-green-200' : tagItem.calculatedStatus === 'EN PROCESO' ? 'text-yellow-700 bg-yellow-100 border-yellow-200' : 'text-slate-400 bg-slate-100 border-slate-200'}`}>
                            {tagItem.calculatedStatus}
                         </span>
                    </td>
                </tr>
            );
        };

        const SpecialtyGroup = ({ specialtyName, tags, onEdit, skidOptions, almacenOptions, isReadOnly }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const total = tags.length;
            const mounted = tags.filter(t => t.calculatedStatus === "INSTALADO").length;
            const percent = total > 0 ? ((mounted / total) * 100).toFixed(0) : 0;
            const iconMap = { "Instrumentación": <Activity size={14} className="text-blue-500"/>, "Electricidad": <Zap size={14} className="text-yellow-500"/>, "Mecánica": <Wrench size={14} className="text-gray-500"/>, "Piping": <Target size={14} className="text-indigo-500"/>, "Civil": <Hammer size={14} className="text-orange-500"/> };
            
            return (
                <div className="border border-slate-200 rounded mb-2 overflow-hidden bg-white shadow-sm">
                    <div className="flex justify-between items-center p-2 px-3 cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex items-center gap-2">
                            {isExpanded ? <ChevronDown size={14} className="text-slate-400"/> : <ChevronRight size={14} className="text-slate-400"/>}
                            <span className="font-bold text-slate-700 text-xs flex items-center gap-2">{iconMap[specialtyName] || <Layers size={14}/>} {specialtyName}</span>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="text-[10px] text-slate-500 font-medium">{mounted}/{total} Inst.</span>
                            <div className="w-16 bg-gray-200 rounded-full h-1.5"><div className={`h-1.5 rounded-full ${percent == 100 ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${percent}%` }}></div></div>
                        </div>
                    </div>
                    {isExpanded && (
                        <div className="overflow-x-auto">
                            <table className="w-full text-[10px] text-left">
                                <thead className="bg-slate-100 text-slate-500 uppercase border-y border-slate-200">
                                    <tr>
                                        <th className="px-4 py-2 font-semibold">TAG</th>
                                        <th className="px-4 py-2 font-semibold">Descripción</th>
                                        <th className="px-2 py-2 font-semibold w-24">Skid</th>
                                        <th className="px-2 py-2 font-semibold w-24">Almacén</th>
                                        <th className="px-2 py-2 font-semibold text-center w-16">Calib?</th>
                                        <th className="px-2 py-2 font-semibold text-center w-16">R. Tot</th>
                                        <th className="px-2 py-2 font-semibold text-center w-16">R. Real</th>
                                        <th className="px-2 py-2 font-semibold text-center w-32">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>{tags.map((tagItem) => <TagEditRow key={tagItem.tag} tagItem={tagItem} onEdit={onEdit} skidOptions={skidOptions} almacenOptions={almacenOptions} isReadOnly={isReadOnly} />)}</tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const ExpandableRow = ({ sys, isExpanded, onToggle, onEdit, skidOptions, almacenOptions, isReadOnly }) => {
            const groupedTags = useMemo(() => {
                const groups = {};
                sys.tags.forEach(t => { const spec = t.specialty || "Sin Especialidad"; if (!groups[spec]) groups[spec] = []; groups[spec].push(t); });
                return groups;
            }, [sys.tags]);

            return (
                <>
                    <tr className={`bg-white hover:bg-blue-50 transition-colors border-b border-slate-100 cursor-pointer ${isExpanded ? 'bg-slate-50 border-l-4 border-l-blue-500' : ''}`} onClick={onToggle}>
                        <td className="px-6 py-4"><div className="flex items-center gap-2 text-slate-500">{isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}<span className="font-medium text-slate-800 text-sm">{sys.sistema}</span></div><div className="text-xs text-slate-400 pl-6">{sys.descSistema}</div></td>
                        <td className="px-6 py-4"><div className="font-medium text-slate-700 text-sm">{sys.subsistema}</div><div className="text-xs text-slate-400">{sys.descSubsistema}</div></td>
                        <td className="px-6 py-4 text-center font-bold text-slate-700 text-sm">{sys.totalTags}</td>
                        <td className="px-6 py-4 text-center"><span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${sys.mountedTags > 0 ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-500'}`}>{sys.mountedTags}</span></td>
                        <td className="px-6 py-4"><div className="flex items-center gap-3"><span className="text-xs font-bold w-8 text-right">{sys.percent}%</span><ProgressBar current={sys.mountedTags} total={sys.totalTags} color={parseFloat(sys.percent) === 100 ? 'bg-green-600' : parseFloat(sys.percent) > 50 ? 'bg-blue-600' : 'bg-orange-400'} /></div></td>
                    </tr>
                    {isExpanded && (
                        <tr><td colSpan="5" className="p-4 bg-slate-50 border-b border-slate-200 shadow-inner"><div className="pl-6"><h4 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2 tracking-wider"><Boxes size={14}/> Detalle por Especialidad (ABM)</h4>{Object.keys(groupedTags).sort().map(specName => (<SpecialtyGroup key={specName} specialtyName={specName} tags={groupedTags[specName]} onEdit={onEdit} skidOptions={skidOptions} almacenOptions={almacenOptions} isReadOnly={isReadOnly} />))}</div></td></tr>
                    )}
                </>
            );
        };

        // --- APP PRINCIPAL ---
        function InstrumentDashboard() {
            // Firebase State
            const [user, setUser] = useState(null);
            const [role, setRole] = useState('viewer'); // 'viewer' | 'admin'
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [loadingData, setLoadingData] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');

            // Data State
            const [matrixData, setMatrixData] = useState([]);
            const [regData, setRegData] = useState([]); 
            const [activeTab, setActiveTab] = useState("dashboard"); 
            const [filter, setFilter] = useState("TODOS");
            const [expandedRows, setExpandedRows] = useState({}); 
            const [manualEdits, setManualEdits] = useState({});
            
            // UI Refs & State
            const fileInputRef = useRef(null);
            const regInputRef = useRef(null); 
            const [uploadStats, setUploadStats] = useState(null);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [isSuccessModalOpen, setIsSuccessModalOpen] = useState(false);
            const [isApprovalModalOpen, setIsApprovalModalOpen] = useState(false);
            const [pendingData, setPendingData] = useState(null);
            const [changeStats, setChangeStats] = useState(null);
            const [hideDeleted, setHideDeleted] = useState(true); 

            const [skidOptions, setSkidOptions] = useState([]);
            const [almacenOptions, setAlmacenOptions] = useState([]);

            // Firebase Globals - Init Seguro
            const { config, appId, isConfigured } = useMemo(() => getFirebaseConfig(), []);
            
            const app = useMemo(() => isConfigured ? initializeApp(config) : null, [config, isConfigured]);
            const auth = useMemo(() => app ? getAuth(app) : null, [app]);
            const db = useMemo(() => app ? getFirestore(app) : null, [app]);

            // --- 1. INITIALIZE FIREBASE AUTH ---
            useEffect(() => {
                if(!auth) {
                    setLoadingAuth(false);
                    return;
                }

                // Autologin eliminado para evitar conflictos en entorno manual
                setLoadingAuth(false);

                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoadingAuth(false);
                    if (u) {
                        // LÓGICA DE ROLES BASADA EN EMAIL (Simple Demo)
                        // Si el email empieza con "admin", es admin.
                        // En producción, esto debería ser vía Custom Claims o una colección 'users'
                        if (u.email && u.email.toLowerCase().startsWith('admin')) {
                            setRole('admin');
                        } else {
                            setRole('viewer');
                        }
                    }
                });
                return () => unsubscribe();
            }, [auth]);

            // --- 2. FIRESTORE DATA SYNC ---
            useEffect(() => {
                if (!user || !db || !isConfigured) return;
                setLoadingData(true);
                setErrorMsg('');
                
                // Escuchamos el documento "Metadata" principal para saber qué hay
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_metadata', 'main');
                
                const unsub = onSnapshot(docRef, async (snap) => {
                    if (snap.exists()) {
                        const meta = snap.data();
                        
                        // Cargar Edits (son pequeños, viven en metadata)
                        if (meta.edits) setManualEdits(JSON.parse(meta.edits));

                        // Cargar Matrix (Si cambió el conteo, recargamos)
                        if (meta.matrixChunkCount > 0) {
                            try {
                                const mData = await fetchLargeData(db, appId, 'matrix_chunks', meta.matrixChunkCount);
                                setMatrixData(mData);
                            } catch(e) { console.error("Error loading matrix chunks", e); }
                        } else {
                            setMatrixData([]);
                        }

                        // Cargar Registry
                        if (meta.registryChunkCount > 0) {
                            try {
                                const rData = await fetchLargeData(db, appId, 'registry_chunks', meta.registryChunkCount);
                                setRegData(rData);
                            } catch(e) { console.error("Error loading registry chunks", e); }
                        } else {
                            setRegData([]);
                        }

                    } else {
                        // DB vacía
                        setMatrixData([]);
                        setRegData([]);
                        setManualEdits({});
                    }
                    setLoadingData(false);
                }, (err) => {
                    console.error("Error fetching data:", err);
                    setLoadingData(false);
                    if(err.code === 'permission-denied') {
                        setErrorMsg('Acceso denegado. Verifica las reglas de Firestore.');
                    } else {
                        setErrorMsg(`Error de conexión: ${err.message}`);
                    }
                });

                return () => unsub();
            }, [user, db, appId, isConfigured]);

            // --- 3. SAVE DATA HELPER ---
            const saveToCloud = async (newMatrix, newReg, newEdits) => {
                if (role !== 'admin' || !db) return;
                try {
                    // 1. Calcular nuevos datos o usar actuales
                    const finalMatrix = newMatrix || matrixData;
                    const finalReg = newReg || regData;
                    const finalEdits = newEdits || manualEdits;

                    // 2. Guardar chunks de Matrix
                    let mCount = 0;
                    if(newMatrix) {
                        mCount = await saveLargeData(db, appId, 'matrix_chunks', JSON.stringify(finalMatrix));
                    } else {
                        // Si no estamos actualizando la matriz, necesitamos saber cuantos chunks hay actualmente.
                        // Para simplificar, leemos del estado actual si no tenemos el conteo a mano,
                        // pero idealmente 'saveToCloud' se llama cuando cambian cosas.
                        // Si solo cambiamos edits, no re-guardamos la matriz gigante.
                        // Hack: leemos el conteo previo si no cambiamos la matriz.
                        // Mejor estrategia: Guardar solo lo que cambió.
                    }

                    // 3. Guardar chunks de Registry
                    let rCount = 0;
                    if(newReg) {
                        rCount = await saveLargeData(db, appId, 'registry_chunks', JSON.stringify(finalReg));
                    }

                    // 4. Actualizar Metadata
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_metadata', 'main');
                    
                    // Necesitamos leer el meta actual para no perder los conteos si solo guardamos edits
                    // pero estamos en un entorno async.
                    // Estrategia segura: merge: true
                    
                    const updatePayload = {
                        edits: JSON.stringify(finalEdits),
                        lastUpdated: new Date().toISOString(),
                        updatedBy: user.email || 'Admin'
                    };

                    if (newMatrix) updatePayload.matrixChunkCount = mCount;
                    if (newReg) updatePayload.registryChunkCount = rCount;

                    await setDoc(docRef, updatePayload, { merge: true });

                } catch (e) {
                    alert("Error guardando en la nube: " + e.message);
                }
            };

            // Options Calc
            useEffect(() => {
                const uniqueSkids = new Set();
                const uniqueAlmacenes = new Set();
                matrixData.forEach(item => {
                    if (item.skid && item.skid.trim() !== "") uniqueSkids.add(item.skid.trim());
                    if (item.almacen && item.almacen.trim() !== "") uniqueAlmacenes.add(item.almacen.trim());
                });
                uniqueAlmacenes.add("EN OBRA");
                setSkidOptions(Array.from(uniqueSkids).sort());
                setAlmacenOptions(Array.from(uniqueAlmacenes).sort());
            }, [matrixData]);

            // Handlers
            const handleLogin = async (credentials) => {
                if(!auth) return;
                setLoadingAuth(true);
                try {
                    const { email, password, isRegistering } = credentials;
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    console.error("Login Error:", err);
                    alert("Error de autenticación: " + err.message);
                } finally {
                    setLoadingAuth(false);
                }
            };

            const handleLogout = () => {
                if(auth) signOut(auth);
                setUser(null);
                setMatrixData([]); // Clear local data on logout
                setRegData([]);
            };

            const performClearData = () => {
                // Para limpiar, guardamos arrays vacíos
                saveToCloud([], [], {});
                setMatrixData([]); setRegData([]); setManualEdits({}); setUploadStats(null); setFilter("TODOS"); setExpandedRows({});
                if (fileInputRef.current) fileInputRef.current.value = "";
                if (regInputRef.current) regInputRef.current.value = "";
                setIsDeleteModalOpen(false);
            };

            const toggleRow = (id) => setExpandedRows(prev => ({...prev, [id]: !prev[id]}));

            const handleTagEdit = (tag, field, value) => {
                if (role !== 'admin') return;

                const updatedEdits = { ...manualEdits };
                
                let newEditsForTag = { ...(updatedEdits[tag] || {}), [field]: value };
                
                // Logic Auto-Almacen
                if (field === 'cantRegReal') {
                    const item = matrixData.find(d => d.tag === tag);
                    const tot = safeParseInt(newEditsForTag.cantRegTot !== undefined ? newEditsForTag.cantRegTot : (item?.cantRegTot || 0));
                    const real = safeParseInt(value);
                    if (tot > 0 && real >= tot) { 
                         newEditsForTag.almacen = "EN OBRA";
                    }
                }
                
                updatedEdits[tag] = newEditsForTag;
                
                // Optimistic UI Update
                setManualEdits(updatedEdits);
                // Save to Cloud (Solo edits)
                saveToCloud(null, null, updatedEdits);
            };
            
            const handleRegEdit = (tag, field, value) => {
                if (role !== 'admin') return;

                const newRegData = regData.map(item => {
                    if(item.tag === tag) {
                        let newState = item.estadoDoc;
                        if (field === 'fDev' && value) newState = "FINALIZADO";
                        else if (field === 'fPres' && value) newState = "EN INSPECCIÓN";
                        else if (field === 'fGen' && value) newState = "EN LABORATORIO";
                        return { ...item, [field]: value, estadoDoc: newState };
                    }
                    return item;
                });

                setRegData(newRegData);
                // Save Reg Data + Edits (null Matrix to skip saving it)
                saveToCloud(null, newRegData, null);
            };

            const calculateState = (item, edit) => {
                const tot = safeParseInt(edit?.cantRegTot !== undefined ? edit.cantRegTot : item.cantRegTot);
                const real = safeParseInt(edit?.cantRegReal !== undefined ? edit.cantRegReal : item.cantRegReal);
                if (tot > 0 && real >= tot) return "INSTALADO";
                if (real > 0 && real < tot) return "EN PROCESO";
                return "PENDIENTE";
            };

            // Filtrado visual
            const filteredMatrixData = useMemo(() => {
                if (!hideDeleted) return matrixData;
                return matrixData.filter(item => {
                    const est = (item.estado1 || "").toUpperCase();
                    return !est.includes("ELIMINA");
                });
            }, [matrixData, hideDeleted]);

            // STATS CALCS
            const systemsStats = useMemo(() => {
                const grouped = {};
                filteredMatrixData.forEach(item => {
                    const tag = item.tag?.trim();
                    const edit = manualEdits[tag];
                    
                    const state = calculateState(item, edit);
                    const isMounted = state === "INSTALADO";
                    const isInProgress = state === "EN PROCESO";
                    const key = `${item.sistema || '000'}|${item.subsistema || '000'}`;

                    if (!grouped[key]) grouped[key] = { id: key, sistema: `${item.sistema} - ${item.descSistema}`, descSistema: item.descSistema, subsistema: `${item.subsistema} - ${item.descSubsistema}`, descSubsistema: item.descSubsistema, totalTags: 0, mountedTags: 0, tags: [] };

                    grouped[key].totalTags++;
                    if (isMounted) grouped[key].mountedTags++;
                    
                    const displayAlmacen = ((isMounted || isInProgress) && (!edit?.almacen && !item.almacen)) ? "EN OBRA" : (edit?.almacen !== undefined ? edit.almacen : item.almacen);

                    grouped[key].tags.push({ 
                        tag, desc: item.descripcion, specialty: item.especialidad, mounted: isMounted, calculatedStatus: state,
                        skid: edit?.skid !== undefined ? edit.skid : item.skid,
                        almacen: displayAlmacen, 
                        aCalibrar: edit?.aCalibrar !== undefined ? edit.aCalibrar : item.aCalibrar,
                        cantRegTot: edit?.cantRegTot !== undefined ? edit.cantRegTot : item.cantRegTot,
                        cantRegReal: edit?.cantRegReal !== undefined ? edit.cantRegReal : item.cantRegReal
                    });
                });
                return Object.values(grouped).map(g => ({ ...g, percent: g.totalTags > 0 ? ((g.mountedTags / g.totalTags) * 100).toFixed(1) : "0.0" })).sort((a, b) => a.sistema.localeCompare(b.sistema));
            }, [filteredMatrixData, manualEdits]);

            const flatData = useMemo(() => {
                return regData.map(item => {
                     let status = "PENDIENTE";
                     if (item.fDev && item.fDev.trim() !== "") status = "FINALIZADO";
                     else if (item.fPres && item.fPres.trim() !== "") status = "EN INSPECCIÓN";
                     else if (item.fGen && item.fGen.trim() !== "") status = "EN LABORATORIO";
                     const estadoRegFisico = (item.ubicReg && item.ubicReg.trim() !== "") ? item.ubicReg : "PENDIENTE";
                     const ubicacionFisicaReal = (item.ubicacion && item.ubicacion.trim() !== "") ? item.ubicacion : "Sin Dato";
                     const provision = (item.provision && item.provision.trim() !== "") ? item.provision : "Sin Dato";
                     const skidStatus = (item.skid && item.skid.trim() !== "") ? item.skid : "Sin Dato";

                     return {
                         tag: item.tag, ubicacionFisica: ubicacionFisicaReal, ubicacionRegistro: estadoRegFisico, proveedor: item.lab || "Sin Prov.", 
                         estadoDoc: status, fechaGen: item.fGen, fechaPres: item.fPres, fechaDev: item.fDev, montado: item.montado, provision: provision, skid: skidStatus
                     };
                });
            }, [regData]);

            const totalDocsScope = useMemo(() => {
                return matrixData.reduce((acc, item) => {
                    const est1 = cleanStr(item.estado1).toUpperCase();
                    if (est1.includes("ELIMINA")) return acc;
                    const edit = manualEdits[item.tag];
                    const val = safeParseInt(edit?.cantRegTot !== undefined ? edit.cantRegTot : item.cantRegTot);
                    return acc + val;
                }, 0);
            }, [matrixData, manualEdits]);

            const globalProgress = useMemo(() => {
                let sumTot = 0; let sumReal = 0;
                matrixData.forEach(item => {
                    const est1 = cleanStr(item.estado1).toUpperCase();
                    if (est1.includes("ELIMINA")) return;
                    const tag = item.tag?.trim();
                    const edit = manualEdits[tag];
                    const valTot = safeParseInt(edit?.cantRegTot !== undefined ? edit.cantRegTot : item.cantRegTot);
                    const valReal = safeParseInt(edit?.cantRegReal !== undefined ? edit.cantRegReal : item.cantRegReal);
                    sumTot += valTot;
                    sumReal += valReal;
                });
                return sumTot === 0 ? "0.0000" : ((sumReal / sumTot) * 100).toFixed(4);
            }, [matrixData, manualEdits]);

            const physicalLocationStats = useMemo(() => {
                const stats = {};
                const provisions = new Set();
                flatData.forEach(item => {
                    const loc = item.ubicacionFisica;
                    const prov = item.provision;
                    provisions.add(prov);
                    if (!stats[loc]) stats[loc] = { name: loc };
                    stats[loc][prov] = (stats[loc][prov] || 0) + 1;
                });
                const sortedData = Object.values(stats).sort((a, b) => a.name.localeCompare(b.name));
                return { data: sortedData, keys: Array.from(provisions).sort() };
            }, [flatData]);

            const skidCounts = useMemo(() => {
                const counts = { ON: 0, OFF: 0 };
                flatData.forEach(d => {
                    const val = (d.skid || "").toUpperCase().trim();
                    if (val === 'ON') counts.ON++;
                    if (val === 'OFF') counts.OFF++;
                });
                return counts;
            }, [flatData]);

            const uniqueLabs = useMemo(() => {
                const labs = new Set();
                regData.forEach(d => {
                    if(d.lab && d.lab.trim() !== '') labs.add(d.lab.trim());
                });
                return Array.from(labs).sort();
            }, [regData]);

            const specialtyStats = useMemo(() => {
                const stats = {
                    "I": { label: "Instrumentación (I)", total: 0, completed: 0, color: "#3b82f6", icon: Activity },
                    "E": { label: "Electricidad (E)", total: 0, completed: 0, color: "#eab308", icon: Zap },
                    "P": { label: "Piping (P)", total: 0, completed: 0, color: "#6366f1", icon: Target },
                    "M": { label: "Mecánica (M)", total: 0, completed: 0, color: "#64748b", icon: Wrench },
                    "C": { label: "Civil (C)", total: 0, completed: 0, color: "#f97316", icon: Hammer },
                };
                matrixData.forEach(item => {
                    const est1 = (item.estado1 || "").toUpperCase();
                    if (est1.includes("ELIMINA")) return;
                    const spec = (item.especialidad || "").toUpperCase();
                    let key = null;
                    if (spec.includes("INSTRUMENT") || spec.includes("(I)")) key = "I";
                    else if (spec.includes("ELECTRIC") || spec.includes("(E)")) key = "E";
                    else if (spec.includes("PIPING") || spec.includes("(P)")) key = "P";
                    else if (spec.includes("MEC") || spec.includes("(M)")) key = "M";
                    else if (spec.includes("CIVIL") || spec.includes("(C)")) key = "C";

                    if (key) {
                        const edit = manualEdits[item.tag];
                        const valTot = safeParseInt(edit?.cantRegTot !== undefined ? edit.cantRegTot : item.cantRegTot);
                        const valReal = safeParseInt(edit?.cantRegReal !== undefined ? edit.cantRegReal : item.cantRegReal);
                        stats[key].total += valTot;
                        stats[key].completed += valReal;
                    }
                });
                return Object.values(stats);
            }, [matrixData, manualEdits]);

            // --- CARGA DE ARCHIVOS ---
            const handleMatrixUpload = (e) => { 
                const file = e.target.files[0]; 
                if(!file) return; 
                const reader = new FileReader(); 
                reader.onload = (ev) => { 
                    const rawText = ev.target.result.replace(/\r/g, '');
                    const lines = rawText.split('\n').filter(l => l.trim().length > 0);
                    const newData = []; 
                    const del = lines[0].includes(';') ? ';' : ','; 
                    const headers = parseCSVLine(lines[0], del).map(h => h.toUpperCase());
                    
                    const idx = {
                        tag: headers.findIndex(h => h === 'TAG'), spec: headers.findIndex(h => h.includes('ESPECIALIDAD') || h === 'ESP'), desc: headers.findIndex(h => h.includes('DESC') && !h.includes('SIS')),
                        sis: headers.findIndex(h => h === 'SISTEMA' || h === 'SIS'), sisDesc: headers.findIndex(h => h.includes('DESC') && h.includes('SIS')), sub: headers.findIndex(h => h.includes('SUB') && !h.includes('DESC')),
                        subDesc: headers.findIndex(h => h.includes('DESC') && h.includes('SUB')), skid: headers.findIndex(h => h === 'SKID'), alm: headers.findIndex(h => h === 'ALMACEN' || h === 'ALM'),
                        calib: headers.findIndex(h => h.includes('CALIBRAR')), prov: headers.findIndex(h => h.includes('PROVISION')), cTot: headers.indexOf('CANTREGTOT') !== -1 ? headers.indexOf('CANTREGTOT') : headers.findIndex(h => h.includes('CANTREG') && h.includes('TOT')),
                        cReal: headers.indexOf('CANTREGREALIZADOS') !== -1 ? headers.indexOf('CANTREGREALIZADOS') : headers.findIndex(h => h.includes('CANTREG') && h.includes('REAL')), est1: headers.indexOf('ESTADO_1') !== -1 ? headers.indexOf('ESTADO_1') : headers.findIndex(h => h.includes('ESTADO_1')), est2: headers.indexOf('ESTADO_2') !== -1 ? headers.indexOf('ESTADO_2') : headers.findIndex(h => h.includes('ESTADO_2'))
                    };
                    lines.forEach((r, i) => { 
                        if (i === 0) return; 
                        const c = parseCSVLine(r, del);
                        const tagVal = cleanStr(c[idx.tag]);
                        if(tagVal && tagVal.toUpperCase() !== "TAG" && !tagVal.toUpperCase().includes("DESCRIPCION")) {
                            newData.push({
                                especialidad: cleanStr(c[idx.spec]), tag: tagVal, descripcion: cleanStr(c[idx.desc]), sistema: cleanStr(c[idx.sis]), descSistema: cleanStr(c[idx.sisDesc]),
                                subsistema: cleanStr(c[idx.sub]), descSubsistema: cleanStr(c[idx.subDesc]), skid: cleanStr(c[idx.skid]), almacen: cleanStr(c[idx.alm]),
                                aCalibrar: cleanStr(c[idx.calib]), provision: cleanStr(c[idx.prov]), cantRegTot: cleanStr(c[idx.cTot]) || "0", cantRegReal: cleanStr(c[idx.cReal]) || "0", estado1: cleanStr(c[idx.est1]), estado2: cleanStr(c[idx.est2])
                            });
                        } 
                    }); 
                    let modCount = 0; let newCount = 0;
                    const currentMap = new Map(matrixData.map(d => [d.tag, d]));
                    newData.forEach(newItem => { const currentItem = currentMap.get(newItem.tag); if (!currentItem) newCount++; else if (newItem.skid !== currentItem.skid || newItem.almacen !== currentItem.almacen) modCount++; });
                    setPendingData(newData);
                    setChangeStats({ total: newData.length, newItems: newCount, modified: modCount });
                    setIsApprovalModalOpen(true);
                }; 
                reader.readAsText(file); 
            };
            
            const handleRegUpload = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const rawText = ev.target.result.replace(/\r/g, '');
                    const lines = rawText.split('\n').filter(l => l.trim().length > 0);
                    const newData = [];
                    const del = lines[0].includes(';') ? ';' : ',';
                    const headers = parseCSVLine(lines[0], del).map(h => h.toUpperCase());
                    const idx = { tag: headers.findIndex(h => h === 'TAG'), skid: headers.findIndex(h => h.includes('SKID')), ubic: headers.findIndex(h => h.includes('UBICA') && !h.includes('REGISTRO')), lab: headers.findIndex(h => h.includes('LABT') || h.includes('CALIB')), fCalib: headers.findIndex(h => h.includes('FECHA') && h.includes('CALIB')), estReg: headers.findIndex(h => h.includes('ESTADO') && h.includes('REGIST')), fGen: headers.findIndex(h => h.includes('GENERADO')), fPres: headers.findIndex(h => h.includes('PRESENTADO')), fDev: headers.findIndex(h => h.includes('DEVOLUCION')), ubicReg: headers.findIndex(h => h.includes('REGISTRO')), montado: headers.findIndex(h => h === 'MONTADO'), prov: headers.findIndex(h => h === 'PROVISION' || h.includes('PROVISION')) };
                    lines.forEach((r, i) => {
                        if (i === 0) return;
                        const c = parseCSVLine(r, del);
                        if(c[idx.tag]) {
                            newData.push({ tag: cleanStr(c[idx.tag]), skid: cleanStr(c[idx.skid]), ubicacion: cleanStr(c[idx.ubic]), lab: cleanStr(c[idx.lab]), fCalib: normalizeDate(c[idx.fCalib]), estadoReg: cleanStr(c[idx.estReg]), fGen: normalizeDate(c[idx.fGen]), fPres: normalizeDate(c[idx.fPres]), fDev: normalizeDate(c[idx.fDev]), ubicReg: cleanStr(c[idx.ubicReg]), montado: cleanStr(c[idx.montado]), provision: idx.prov !== -1 ? cleanStr(c[idx.prov]) : "Sin Dato" });
                        }
                    });
                    
                    setRegData(newData);
                    saveToCloud(null, newData, null);
                    
                    setUploadStats({type:'Registro Instrumentos', total:newData.length});
                    setIsSuccessModalOpen(true);
                    setActiveTab('dashboard'); 
                };
                reader.readAsText(file);
            };

            const confirmMatrixLoad = () => {
                if (pendingData) {
                    setMatrixData(pendingData);
                    saveToCloud(pendingData, null, {}); 

                    setUploadStats({type:'Matriz Actualizada', total: pendingData.length});
                    setManualEdits({}); 
                    setIsApprovalModalOpen(false);
                    setIsSuccessModalOpen(true);
                    setActiveTab('systems');
                }
            };

            const downloadExport = () => {
                let csvContent = "data:text/csv;charset=utf-8,TAG;ESTADO;DOC_TOT;DOC_REAL\n";
                matrixData.forEach(row => {
                    const edit = manualEdits[row.tag];
                    const state = calculateState(row, edit);
                    csvContent += `${row.tag};${state};${edit?.cantRegTot||row.cantRegTot};${edit?.cantRegReal||row.cantRegReal}\n`;
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "avance_obra.csv");
                document.body.appendChild(link);
                link.click();
            };

            const docStatusCounts = useMemo(() => {
                const counts = flatData.reduce((acc, curr) => { const st = curr.estadoDoc || "PENDIENTE"; acc[st] = (acc[st] || 0) + 1; return acc; }, {});
                return Object.keys(counts).map(key => ({ name: key, value: counts[key] }));
            }, [flatData]);

            const registryStatusCounts = useMemo(() => {
                const counts = flatData.reduce((acc, curr) => { const st = curr.ubicacionRegistro || "PENDIENTE"; acc[st] = (acc[st] || 0) + 1; return acc; }, {});
                return Object.keys(counts).map(key => ({ name: key, value: counts[key] }));
            }, [flatData]);

            const filteredList = filter === "TODOS" ? flatData : flatData.filter(d => d.estadoDoc === filter || d.ubicacion === filter);

            // --- RENDER LOGIC ---
            if (!user) {
                return <LoginScreen onLogin={handleLogin} loading={loadingAuth} isConfigured={isConfigured} />;
            }

            return (
                <div className="min-h-screen bg-slate-50 p-6 font-sans relative">
                    <ConfirmModal isOpen={isDeleteModalOpen} onClose={() => setIsDeleteModalOpen(false)} onConfirm={performClearData} />
                    <SuccessModal isOpen={isSuccessModalOpen} onClose={() => setIsSuccessModalOpen(false)} message={`Datos cargados y sincronizados. Total: ${uploadStats?.total || 0}`} />
                    <ApprovalModal isOpen={isApprovalModalOpen} onClose={() => setIsApprovalModalOpen(false)} onConfirm={confirmMatrixLoad} changes={changeStats} />

                    <div className="flex flex-col gap-4 mb-6">
                        {/* HEADER CON INFO DE USUARIO */}
                        <div className="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-2">
                            <div className="flex items-center gap-3">
                                {role === 'admin' ? 
                                    <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Shield size={20}/></div> : 
                                    <div className="bg-gray-100 p-2 rounded-full text-gray-500"><Eye size={20}/></div>
                                }
                                <div>
                                    <p className="text-xs text-slate-400 font-bold uppercase">Conectado como</p>
                                    <p className="text-sm font-bold text-slate-700">{role === 'admin' ? (user.email || 'Administrador') : 'Invitado (Solo Lectura)'}</p>
                                </div>
                                {loadingData && <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded animate-pulse flex items-center gap-1"><Database size={12}/> Sincronizando...</span>}
                            </div>
                            <button onClick={handleLogout} className="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-sm flex items-center gap-2 font-medium transition-colors"><LogOut size={16}/> Salir</button>
                        </div>
                        
                        {/* ERROR MSG BANNER */}
                        {errorMsg && (
                             <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4 rounded shadow-sm flex items-start gap-3">
                                 <AlertCircle className="text-red-500 shrink-0 mt-0.5" size={20}/>
                                 <div>
                                     <h3 className="text-red-800 font-bold text-sm">Error de Conexión</h3>
                                     <p className="text-red-700 text-sm">{errorMsg}</p>
                                 </div>
                             </div>
                        )}

                        <div className="flex flex-col xl:flex-row justify-between items-center bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3">Seguimiento de Obra {uploadStats && <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Cargado: {uploadStats.type}</span>}</h1>
                                <p className="text-slate-500">Gestión Unificada de Matriz de Ingeniería y Avance</p>
                            </div>
                            
                            <div className="flex gap-2 mt-4 xl:mt-0">
                                <button onClick={() => setHideDeleted(!hideDeleted)} className={`flex items-center gap-2 px-4 py-2 rounded text-sm border font-medium transition-colors ${hideDeleted ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-gray-100 text-gray-500 border-gray-300'}`}>{hideDeleted ? <EyeOff size={16}/> : <Eye size={16}/>} {hideDeleted ? "Ocultando Eliminados" : "Ver Eliminados"}</button>
                                
                                <button onClick={downloadExport} className="flex items-center gap-2 bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded text-sm hover:bg-slate-50"><Save size={16}/> Guardar (CSV)</button>

                                {/* CONTROLES DE ADMIN */}
                                {role === 'admin' && (
                                    <>
                                        <div className="h-8 w-px bg-slate-300 mx-2"></div>
                                        <button onClick={() => setIsDeleteModalOpen(true)} className="flex items-center gap-2 bg-white border border-red-200 text-red-600 px-4 py-2 rounded text-sm hover:bg-red-50"><Trash2 size={16}/> Limpiar Nube</button>
                                        
                                        <input type="file" ref={fileInputRef} onChange={handleMatrixUpload} accept=".csv" className="hidden" />
                                        <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700 shadow-md transform active:scale-95 transition-transform"><Upload size={16}/> Matriz</button>
                                        
                                        <input type="file" ref={regInputRef} onChange={handleRegUpload} accept=".csv" className="hidden" />
                                        <button onClick={() => regInputRef.current.click()} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 shadow-md transform active:scale-95 transition-transform"><Upload size={16}/> Registros</button>
                                    </>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-6 border-b border-slate-200 px-4">
                            <button onClick={() => setActiveTab("dashboard")} className={`pb-3 px-2 flex items-center gap-2 transition-colors ${activeTab === 'dashboard' ? 'tab-active' : 'tab-inactive'}`}><LayoutDashboard size={20}/> Registro de Instrumentos</button>
                            <button onClick={() => setActiveTab("systems")} className={`pb-3 px-2 flex items-center gap-2 transition-colors ${activeTab === 'systems' ? 'tab-active' : 'tab-inactive'}`}><Layers size={20}/> Sistemas & ABM</button>
                        </div>
                    </div>

                    {activeTab === 'dashboard' && (
                        <div className="animate-enter">
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                                <MetricCard title="Instrumentos Reg." value={flatData.length} percentage="100" icon={Activity} color="#6366f1" />
                                <MetricCard title="Finalizados" value={flatData.filter(d => d.estadoDoc === "FINALIZADO").length} percentage={flatData.length > 0 ? ((flatData.filter(d => d.estadoDoc === "FINALIZADO").length / flatData.length) * 100).toFixed(0) : 0} icon={CheckCircle} color="#15803d" />
                                <MetricCard title="En Inspección" value={flatData.filter(d => d.estadoDoc === "EN INSPECCIÓN").length} percentage={flatData.length > 0 ? ((flatData.filter(d => d.estadoDoc === "EN INSPECCIÓN").length / flatData.length) * 100).toFixed(0) : 0} icon={Clock} color="#eab308" />
                                <MetricCard title="Laboratorio" value={flatData.filter(d => d.estadoDoc === "EN LABORATORIO").length} icon={Wrench} color="#f97316" />
                                <MetricCard title="Estado Skid" value={`ON: ${skidCounts.ON} | OFF: ${skidCounts.OFF}`} icon={Box} color="#8b5cf6" />
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                <div className="bg-white p-6 rounded-lg shadow border border-slate-100 h-80">
                                    <h3 className="text-lg font-bold text-slate-700 mb-4">Estado Documental</h3>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={docStatusCounts} layout="vertical" margin={{top: 5, right: 30, left: 20, bottom: 5}}>
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                            <XAxis type="number" />
                                            <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 10}} />
                                            <Tooltip />
                                            <Bar dataKey="value" fill="#3b82f6" radius={[0,4,4,0]}>
                                                 <LabelList dataKey="value" position="right" />
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow border border-slate-100 h-80">
                                    <h3 className="text-lg font-bold text-slate-700 mb-4">Estado del registro</h3>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={registryStatusCounts} cx="50%" cy="50%" innerRadius={40} outerRadius={70} fill="#8884d8" paddingAngle={5} dataKey="value" label>
                                                {registryStatusCounts.map((entry, index) => <Cell key={`cell-${index}`} fill={Object.values(COLORS)[index % Object.values(COLORS).length]} />)}
                                            </Pie>
                                            <Tooltip />
                                            <Legend />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow border border-slate-100 h-80">
                                    <h3 className="text-lg font-bold text-slate-700 mb-4">Ubicación Física por Provisión</h3>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={physicalLocationStats.data} layout="vertical" margin={{top: 5, right: 30, left: 20, bottom: 5}}>
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                            <XAxis type="number" />
                                            <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 10}} />
                                            <Tooltip />
                                            <Legend wrapperStyle={{fontSize: "10px"}}/>
                                            {physicalLocationStats.keys.map((key, index) => (
                                                <Bar key={key} dataKey={key} stackId="a" fill={COLORS_LIST[index % COLORS_LIST.length]} />
                                            ))}
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow overflow-hidden border border-slate-200">
                                <div className="p-5 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                                    <h3 className="text-lg font-bold text-slate-700">Listado de Registros (ABM)</h3>
                                    <select className="select-edit w-48" value={filter} onChange={(e) => setFilter(e.target.value)}>
                                        <option value="TODOS">Todos</option>
                                        <option value="FINALIZADO">Finalizados</option>
                                        <option value="EN INSPECCIÓN">En Inspección</option>
                                        <option value="EN OBRA">En Obra</option>
                                    </select>
                                </div>
                                <div className="overflow-x-auto max-h-96">
                                    <table className="w-full text-sm text-left text-slate-600">
                                        <thead className="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                                            <tr>
                                                <th className="px-6 py-3">TAG</th>
                                                <th className="px-2 py-3 w-32">Lab</th>
                                                <th className="px-2 py-3 w-32">Generado</th>
                                                <th className="px-2 py-3 w-32">Presentado</th>
                                                <th className="px-2 py-3 w-32">Devolución</th>
                                                <th className="px-6 py-3">Estado Doc.</th>
                                                <th className="px-6 py-3 font-bold text-right">Estado del registro</th>
                                                <th className="px-2 py-3 text-center w-32">Montado</th>
                                                <th className="px-2 py-3 text-center w-32">Skid</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {filteredList.map((row, idx) => (
                                                <tr key={idx} className="bg-white hover:bg-slate-50">
                                                    <td className="px-6 py-3 font-medium">{row.tag}</td>
                                                    <td className="px-2 py-1">
                                                        <select 
                                                            disabled={role !== 'admin'}
                                                            className="select-edit" 
                                                            value={row.proveedor === "Sin Prov." ? "" : row.proveedor} 
                                                            onChange={(e) => handleRegEdit(row.tag, 'lab', e.target.value)}
                                                        >
                                                            <option value="">-</option>
                                                            {uniqueLabs.map(lab => (
                                                                <option key={lab} value={lab}>{lab}</option>
                                                            ))}
                                                        </select>
                                                    </td>
                                                    <td className="px-2 py-1"><input disabled={role !== 'admin'} type="date" className="input-edit" value={row.fechaGen} onChange={(e) => handleRegEdit(row.tag, 'fGen', e.target.value)}/></td>
                                                    <td className="px-2 py-1"><input disabled={role !== 'admin'} type="date" className="input-edit" value={row.fechaPres} onChange={(e) => handleRegEdit(row.tag, 'fPres', e.target.value)}/></td>
                                                    <td className="px-2 py-1"><input disabled={role !== 'admin'} type="date" className="input-edit" value={row.fechaDev} onChange={(e) => handleRegEdit(row.tag, 'fDev', e.target.value)}/></td>
                                                    <td className="px-6 py-3"><span className={`px-2 py-1 rounded text-xs font-bold ${row.estadoDoc === 'FINALIZADO' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>{row.estadoDoc}</span></td>
                                                    <td className="px-6 py-3 font-bold text-right text-slate-600">{row.ubicacionRegistro}</td>
                                                    <td className="px-2 py-1">
                                                        <select disabled={role !== 'admin'} className="select-edit" value={row.montado} onChange={(e) => handleRegEdit(row.tag, 'montado', e.target.value)}>
                                                            <option value="SIN MONTAR">SIN MONTAR</option>
                                                            <option value="MONTADO">MONTADO</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-2 py-1 text-center">
                                                        <span className={`px-2 py-1 rounded text-xs font-bold ${row.skid === 'Sin Dato' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'}`}>
                                                            {row.skid}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'systems' && (
                        <div className="animate-enter">
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                                {specialtyStats.map((spec) => (
                                    <MetricCard 
                                        key={spec.label} 
                                        title={spec.label} 
                                        value={`${spec.completed}/${spec.total}`} 
                                        percentage={spec.total > 0 ? ((spec.completed / spec.total) * 100).toFixed(0) : 0} 
                                        icon={spec.icon} 
                                        color={spec.color} 
                                        compact={true}
                                    />
                                ))}
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                <div className="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                                    <h3 className="text-sm font-medium text-gray-500 uppercase">Subsistemas</h3>
                                    <p className="text-3xl font-bold text-gray-800">{systemsStats.length}</p>
                                </div>
                                <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                                    <h3 className="text-sm font-medium text-gray-500 uppercase">Total Tags</h3>
                                    <p className="text-3xl font-bold text-gray-800">{filteredMatrixData.length}</p>
                                </div>
                                <div className="bg-white p-4 rounded-lg shadow border-l-4 border-cyan-500">
                                    <h3 className="text-sm font-medium text-gray-500 uppercase">Total Registros</h3>
                                    <div className="flex justify-between items-center">
                                        <p className="text-3xl font-bold text-gray-800">{totalDocsScope}</p>
                                        <div className="p-2 bg-cyan-50 rounded-full">
                                            <FileText size={20} className="text-cyan-600" />
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-600">
                                    <h3 className="text-sm font-medium text-gray-500 uppercase">Avance Global</h3>
                                    <p className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                        {globalProgress}%
                                        <Activity size={20} className="text-green-500"/>
                                    </p>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow overflow-hidden border border-slate-200">
                                <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-700">Detalle de Montaje por Subsistema (ABM)</div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-600">
                                        <thead className="text-xs text-slate-700 uppercase bg-slate-100">
                                            <tr><th className="px-6 py-3">Sistema</th><th className="px-6 py-3">Subsistema</th><th className="px-6 py-3 text-center">Total</th><th className="px-6 py-3 text-center">Instalado</th><th className="px-6 py-3 w-32">Avance</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {systemsStats.map((sys) => (
                                                <ExpandableRow key={sys.id} sys={sys} isExpanded={expandedRows[sys.id]} onToggle={() => toggleRow(sys.id)} onEdit={handleTagEdit} skidOptions={skidOptions} almacenOptions={almacenOptions} isReadOnly={role !== 'admin'} />
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<InstrumentDashboard />);
    </script>
</body>
</html>